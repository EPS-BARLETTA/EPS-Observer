<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>EPS Observer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f6f8fb;--card:#fff;--text:#0f172a;--muted:#6b7280;--border:#e5e7eb;
      --green:#16a34a;--green-dark:#065f46;--red:#ef4444;--amber:#f59e0b;--blue:#2563eb;
      --shadow:0 2px 12px rgba(15,23,42,.06);

      /* Couleurs CA */
      --ca1:#2563eb;    /* bleu */
      --ca2:#059669;    /* vert */
      --ca3:#7c3aed;    /* violet */
      --ca4:#d97706;    /* orange */
      --ca5:#0ea5e9;    /* cyan */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .app{min-height:100dvh;display:flex;flex-direction:column}
    .header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);padding:10px 16px;display:flex;gap:8px;align-items:center;justify-content:flex-end;z-index:10;box-shadow:var(--shadow)}
    .btn{border:0;border-radius:12px;padding:10px 16px;cursor:pointer;font-weight:700;letter-spacing:.2px;box-shadow:var(--shadow)}
    .btn-green{background:var(--green);color:#fff}
    .btn-green-dark{background:var(--green-dark);color:#fff}
    .btn-blue{background:var(--blue);color:#fff}
    .btn-gray{background:#e5e7eb}
    .btn-red{background:#ef4444;color:#fff}
    .btn-amber{background:#f59e0b;color:#111}
    .main{flex:1;display:flex;align-items:center;justify-content:center;padding:24px}
    .section{width:min(1100px,95vw)}
    .pageTitle{text-align:center;margin:8px 0 20px}
    .pageTitle h1{font-size:34px;line-height:1.1;margin:0}
    .pageTitle .sub{color:var(--muted);font-size:14px;margin-top:6px}
    .hero{display:grid;place-items:center;height:70vh;text-align:center}
    .hero h1{font-size:56px;line-height:1.05;margin:0 0 8px}
    .hero p{color:var(--muted);font-size:18px;margin:0 0 28px}
    .start{font-size:18px;padding:14px 28px;border-radius:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 320px}
    .card{background:#fff;border:1px solid var(--border);border-radius:18px;padding:14px;box-shadow:var(--shadow)}
    .title{font-weight:800;margin-bottom:8px;display:flex;align-items:center;gap:10px}
    .muted{color:var(--muted);font-size:12px}
    input[type="text"],input[type="number"],textarea{width:100%;border:1px solid var(--border);border-radius:12px;padding:10px;font-size:16px;background:#fff}
    input::placeholder, textarea::placeholder{color:#9ca3af}
    textarea{min-height:84px;resize:vertical}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{background:#eef2ff;color:#3730a3;border:1px solid #e0e7ff;border-radius:999px;padding:6px 10px;font-size:13px;display:inline-flex;gap:8px;align-items:center}
    .chip button{border:0;background:transparent;cursor:pointer;color:#6b7280}
    .grid{display:grid;gap:10px}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    .bar{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .seg{border:1px dashed var(--border);padding:8px;border-radius:12px;margin-top:8px;background:#fff}
    .tile{border:1px solid var(--border);border-radius:16px;padding:14px;background:#fff;box-shadow:var(--shadow);text-decoration:none;color:inherit;display:flex;flex-direction:column;gap:6px;transition:transform .06s ease, box-shadow .12s ease}
    .tile .big{font-size:18px;font-weight:900}
    .tile .small{font-size:12px;color:var(--muted)}
    .tile:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(15,23,42,.10)}
    .obs-item{display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff}
    .count{min-width:56px;text-align:center;border:1px solid var(--border);border-radius:10px;padding:8px;font-weight:800}
    .buzzer{width:64px;height:64px;border-radius:999px;font-size:28px;display:inline-flex;align-items:center;justify-content:center}
    .fmb{display:flex;gap:6px;flex-wrap:wrap}
    .fmb button{border:0;border-radius:10px;padding:8px 10px;background:#e5e7eb;cursor:pointer}
    .fmb button.active{outline:2px solid #111;outline-offset:2px;background:#fff}
    .footer{border-top:1px solid var(--border);background:#fff;padding:10px 16px;text-align:center;color:#6b7280;font-size:12px}
    .hidden{display:none}
    /* PRINT / PDF */
    .print-page{
      background:#fff;border:1px solid var(--border);box-shadow:var(--shadow);
      padding:20px;border-radius:18px;
      -webkit-print-color-adjust: exact; print-color-adjust: exact; color-adjust: exact;
    }
    .print-header{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:10px}
    .print-title{font-size:22px;font-weight:900;letter-spacing:.3px}
    .print-sub{color:var(--muted);font-size:12px}
    .print-card{border:1px solid var(--border);border-radius:14px;padding:12px;margin-bottom:12px;background:#fff}
    .avoid-break{break-inside:avoid;page-break-inside:avoid}
    .dot{display:inline-block;width:10px;height:10px;border-radius:999px;margin-right:8px;vertical-align:baseline}
    .dot.red{background:#ef4444}.dot.amber{background:#f59e0b}.dot.green{background:#22c55e}.dot.blue{background:#3b82f6}
    @page{ size:A4; margin:14mm 12mm; }
    @media print{
      .header,.nav,.no-print,.modal{display:none!important}
      body{background:#fff}
    }

    /* Ribbons color√©es pour les blocs CA */
    .ca-card{position:relative; overflow:hidden}
    .ca-card::before{
      content:""; position:absolute; inset:auto 0 0 0; height:6px;
      background:var(--ca-color);
      border-bottom-left-radius:16px; border-bottom-right-radius:16px;
    }
    .title .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:900; color:#fff; letter-spacing:.2px; background:var(--ca-color)}

    /* Toast */
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      top:14px; background:#111; color:#fff; padding:10px 14px; border-radius:999px;
      box-shadow:0 8px 24px rgba(0,0,0,.25); font-size:14px; z-index:50; opacity:0; pointer-events:none;
      transition:opacity .2s ease, transform .2s ease;
    }
    .toast.show{opacity:1; transform:translate(-50%,0)}
  </style>
</head>
<body>
<div class="app">
  <header class="header">
    <button class="btn btn-amber" id="btnHelp">‚ùì Aide</button>
    <button class="btn btn-red" id="btnHardReset">‚ôªÔ∏è Reset</button>
  </header>

  <main class="main">
    <!-- PAGE 1 : COVER -->
    <section id="page-cover" class="section">
      <div class="hero">
        <div>
          <h1>EPS Observer</h1>
          <p>Tous champs CA1 √† C5 & toutes APSA</p>
          <button class="btn btn-green start" id="goSetup">Commencer</button>
        </div>
      </div>
    </section>

    <!-- PAGE 2 : CHOIX CA / APSA + CONTEXTE -->
    <section id="page-choose" class="section hidden">
      <div class="pageTitle">
        <h1>Activit√©</h1>
        <div class="sub">S√©lectionne un champ (CA1‚ÜíCA5), choisis une APSA de base, ou ajoute la tienne.</div>
      </div>

      <div class="row">
        <div class="col card">
          <div class="title">üëÄ Observateur¬∑rice(s)</div>
          <input type="text" id="obsInput" placeholder="ex. Ambre, L√©o" />
          <div class="chips" id="obsChips"></div>
          <div class="muted">Entr√©e, virgule, point-virgule ou retour ligne pour ajouter.</div>
        </div>
        <div class="col card">
          <div class="title">üë• Groupe observ√©</div>
          <input type="text" id="grpInput" placeholder="ex. In√®s, L√©o" />
          <div class="chips" id="grpChips"></div>
        </div>
      </div>

      <div id="champsGrid" class="grid" style="grid-template-columns:repeat(1,minmax(0,1fr)); gap:14px; margin-top:12px"></div>
    </section>

    <!-- PAGE 3 : OBSERVABLES (pr√©-config) -->
    <section id="page-observables" class="section hidden">
      <div class="pageTitle">
        <h1>Observables</h1>
        <div class="sub">S√©lectionne/ajoute des observables pour <b id="obsAPSA">‚Äî</b></div>
      </div>

      <div class="card">
        <div id="obsList" class="grid"></div>
        <div class="row" style="margin-top:8px">
          <input id="newObs" placeholder="Ajouter un observable" />
          <button class="btn btn-blue" id="btnAddObs">‚ûï Ajouter</button>
        </div>
      </div>

      <div class="nav" style="margin-top:12px">
        <button class="btn btn-gray" id="backChoose">‚¨ÖÔ∏è Activit√©</button>
        <button class="btn btn-green" id="startObserve">D√©marrer l'observation ‚ñ∂Ô∏è</button>
      </div>
    </section>

    <!-- PAGE 4 : OBSERVATION -->
    <section id="page-observe" class="section hidden">
      <div class="pageTitle">
        <h1>Observation ‚Äî <span id="titleAPSA">‚Äî</span></h1>
        <div class="sub">Tap + / ‚àí ‚Ä¢ 4 niveaux : üî¥/üü°/üü¢/üîµ ‚Ä¢ Ajout √† la vol√©e</div>
      </div>

      <div id="observeList" class="card"></div>

      <div class="nav">
        <button class="btn btn-gray" id="obBack">‚¨ÖÔ∏è Observables</button>
        <div class="row">
          <button class="btn btn-amber" id="obAdd">‚ûï Observable</button>
          <button class="btn btn-green" id="obToBilan">üìë Bilan</button>
        </div>
      </div>
    </section>

    <!-- PAGE 5 : BILAN -->
    <section id="page-bilan" class="section hidden">
      <div class="print-page">
        <div class="print-header">
          <div>
            <div class="print-title">Bilan d'observation</div>
            <div class="print-sub" id="bilanSubtitle">‚Äî</div>
          </div>
          <div class="print-sub" id="bilanMeta">Date : ‚Äî</div>
        </div>

        <div id="bilanContent"></div>

        <div class="nav" style="margin-top:14px">
          <button class="btn btn-gray" id="bilanBack">‚¨ÖÔ∏è Retour</button>
          <div class="row">
            <button class="btn btn-green-dark" id="bilanExportPDF">üìÑ Exporter (impression)</button>
          </div>
        </div>
      </div>

      <div class="footer">EPS Observer ‚Äì JB</div>
    </section>
  </main>

  <footer class="footer">
    EPS Observer ‚Äì √âquipe EPS Lyc√©e Vauban ‚Äì LUXEMBOURG ‚Äì JB
  </footer>
</div>

<!-- Toast -->
<div id="toast" class="toast">APSA s√©lectionn√©e</div>

<script>
/* ======= Donn√©es officielles (CA + APSA de base) & observables ======= */
const CHAMPS = [
  { id:"CA1", color:"var(--ca1)", label:"R√©aliser une performance motrice maximale mesurable", baseAPSA:[
    "Course de 1/2 fond","Course de relais","Combin√© athl√©tique","Natation de vitesse"
  ]},
  { id:"CA2", color:"var(--ca2)", label:"Adapter son d√©placement √† des environnements vari√©s et incertains", baseAPSA:[
    "Escalade","Course d‚Äôorientation","Sauvetage aquatique"
  ]},
  { id:"CA3", color:"var(--ca3)", label:"Cr√©er et r√©aliser une prestation √† vis√©e artistique ou acrobatique", baseAPSA:[
    "Danse contemporaine","Arts du cirque","Acrosport","Gymnastique au sol","Danse de couple"
  ]},
  { id:"CA4", color:"var(--ca4)", label:"Conduire et ma√Ætriser un affrontement individuel ou collectif", baseAPSA:[
    "Badminton","Tennis de table","Boxe fran√ßaise","Basket-ball","Football","Handball","Rugby","Volley-ball","Judo"
  ]},
  { id:"CA5", color:"var(--ca5)", label:"R√©aliser et orienter son activit√© physique pour entretenir sa sant√©", baseAPSA:[
    "Course en dur√©e","Musculation","Natation en dur√©e","Step","Yoga"
  ]},
];
const DEFAULT_OBS = {
  "Basket-ball":["Passe","Tir","Rebond","Aide d√©fensive"],
  "Football":["Passe","Tir","Pressing","Repli d√©fensif"],
  "Handball":["Passe","Tir","Bloc/d√©calage","Retour d√©fensif"],
  "Rugby":["Passe","Avanc√©e","Placage","Soutien"],
  "Volley-ball":["Service","R√©ception","Contre","Attaque"],
  "Badminton":["Service","Amorti","D√©gag√©","Smash"],
  "Tennis de table":["Service","Topspin","Remise","Bloc"],
  "Judo":["Saisie","D√©s√©quilibre","Projection","Immobilisation"],
  "Boxe fran√ßaise":["Direct","Fouett√©","Parade","Esquive"],
  "Escalade":["Lecture de voie","Appuis","Prises","Gestion de l‚Äôeffort"],
  "Course d‚Äôorientation":["Lecture carte","Choix itin√©raire","Pr√©cision poste","Gestion allure"],
  "Natation de vitesse":["D√©part","Fr√©quence/Amplitude","Virage","Arriv√©e"],
  "Natation en dur√©e":["Allure","Distance","R√©gularit√©","Technique"],
  "Course en dur√©e":["Allure","R√©gularit√©","FC/ressenti","Pacing"],
  "Musculation":["Technique","Charge","R√©p√©titions","R√©cup√©ration"],
  "Step":["Complexit√© des pas","Synchronisation","Rythme","S√©curit√©"],
  "Gymnastique au sol":["√âl√©ments","Liaisons","Amplitude","Tenue"],
  "Acrosport":["Port√©s","Voltige","S√©curit√©","Synchronisation"],
  "Danse de couple":["Synchronisation","Guidage","Musicalit√©","Connexion"],
  "Danse contemporaine":["Intention","Espace","Temps","Qualit√© du mouvement"],
  "Arts du cirque":["Num√©ro","Ma√Ætrise objet","Risque contr√¥l√©","Pr√©sence"],
  "Combin√© athl√©tique":["Course","Saut","Lancer","Transitions"],
  "Course de 1/2 fond":["Allure","Relances","Gestion effort","Arriv√©e"],
  "Course de relais":["Transmission","Placement","Allure","Coordination"],
  "Sauvetage aquatique":["Immersion","Saisie","Remorquage","Gestion effort"]
};

/* ===== PERSISTENCE ===== */
const STORAGE_KEY = "eps_observer_acrostyle_v2";
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(app)); }
function load(){ try{ const raw=localStorage.getItem(STORAGE_KEY); if(raw) Object.assign(app, JSON.parse(raw)); }catch{} }
function hardReset(){
  if(!confirm("Tout r√©initialiser ?")) return;
  localStorage.removeItem(STORAGE_KEY);
  Object.assign(app, freshApp());
  renderAll(); show("cover"); save();
}

/* ===== APP STATE ===== */
function freshApp(){
  return {
    observers: [],
    group: [],
    champs: JSON.parse(JSON.stringify(CHAMPS)), // for add APSA
    selected: { champ:null, apsa:null },
    observables: [], // current APSA selection
    observations: [], // history
    current: null,    // in-progress observation
  };
}
const app = freshApp();

/* ===== DOM HELPERS ===== */
const $ = (id)=>document.getElementById(id);
function toChips(container, arr, onRemove){
  container.innerHTML = "";
  (arr||[]).forEach((name, i)=>{
    const s = document.createElement("span");
    s.className = "chip";
    s.innerHTML = `<span>${name}</span>`;
    const b = document.createElement("button");
    b.textContent = "√ó"; b.onclick = ()=> onRemove(i);
    s.appendChild(b); container.appendChild(s);
  });
}

/* ===== NAV ===== */
function show(which){
  ["page-cover","page-choose","page-observables","page-observe","page-bilan"].forEach(id=>$(id).classList.add("hidden"));
  const map={cover:"page-cover", choose:"page-choose", observables:"page-observables", observe:"page-observe", bilan:"page-bilan"};
  $(map[which]).classList.remove("hidden");
}

/* ===== TOAST ===== */
let toastTimer=null;
function toast(msg){
  const t=$("toast"); if(!t) return;
  t.textContent=msg;
  t.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove("show"), 1600);
}

/* ===== CHAMPS UI ===== */
function renderChamps(){
  const grid = $("champsGrid"); grid.innerHTML = "";
  app.champs.forEach(c=>{
    const sec = document.createElement("div"); sec.className="card ca-card";
    sec.style.setProperty('--ca-color', c.color);
    sec.innerHTML = `<div class="title"><span class="pill">${c.id}</span> <span>${c.label}</span></div>`;
    const g = document.createElement("div"); g.className = "grid grid-4";
    (c.baseAPSA||[]).forEach(name=>{
      const a = document.createElement("a");
      a.className="tile";
      a.href="javascript:void(0)";
      a.innerHTML = `<div class="big">${name}</div><div class="small">S√©lectionner</div>`;
      a.onclick = ()=>{
        app.selected.champ=c.id; app.selected.apsa=name; save();
        ensureObservables(app.selected.apsa);
        toast(`APSA s√©lectionn√©e : ${name}`);
        renderObservables(); show("observables");
      };
      g.appendChild(a);
    });
    // add
    const add = document.createElement("div"); add.className="tile";
    add.innerHTML = `<div class="big">‚ûï Ajouter une APSA</div><div class="small">Personnaliser ce champ</div>
      <div class="row" style="margin-top:8px"><input placeholder="Nom de l'APSA" id="in-${c.id}"><button class="btn btn-gray" id="btn-${c.id}">Ajouter</button></div>`;
    g.appendChild(add);
    add.querySelector(`#btn-${c.id}`).onclick = ()=>{
      const v = add.querySelector(`#in-${c.id}`).value.trim(); if(!v) return;
      if(!c.baseAPSA.includes(v)) c.baseAPSA.push(v);
      app.selected.champ=c.id; app.selected.apsa=v;
      save(); renderChamps();
      ensureObservables(v);
      toast(`APSA ajout√©e : ${v}`);
      renderObservables(); show("observables");
    };
    sec.appendChild(g); grid.appendChild(sec);
  });
}

function ensureObservables(apsa){
  if(app.observablesFor!==apsa){
    app.observablesFor = apsa;
    app.observables = (DEFAULT_OBS[apsa]||["Observable 1","Observable 2"]).map(t=>({text:t,pos:0,neg:0,level:"moyen"}));
  }
  return app.observables;
}

/* ===== RENDERS ===== */
function renderChoose(){
  toChips($("obsChips"), app.observers, (i)=>{ app.observers.splice(i,1); save(); renderChoose(); });
  toChips($("grpChips"), app.group, (i)=>{ app.group.splice(i,1); save(); renderChoose(); });
  renderChamps();
}
function renderObservables(){
  $("obsAPSA").textContent = app.selected.apsa || "‚Äî";
  const list = $("obsList"); list.innerHTML="";
  ensureObservables(app.selected.apsa).forEach((o,i)=>{
    const row = document.createElement("div"); row.className="seg";
    row.innerHTML = `<div>${o.text}</div>`;
    const del = document.createElement("button"); del.className="btn btn-gray"; del.textContent="Supprimer";
    del.style.marginTop="6px"; del.onclick = ()=>{ app.observables.splice(i,1); save(); renderObservables(); };
    row.appendChild(del); list.appendChild(row);
  });
}
function renderObserve(){
  $("titleAPSA").textContent = app.selected.apsa || "‚Äî";
  const cont = $("observeList");
  cont.innerHTML="";
  if(!app.current){ cont.innerHTML = `<div class="muted" style="padding:10px">Aucune observation en cours.</div>`; return; }
  app.current.items.forEach((it, idx)=>{
    const row=document.createElement("div"); row.className="obs-item";
    const name=document.createElement("div"); name.textContent=it.text;
    const ctr=document.createElement("div"); ctr.className='row';
    const minus=document.createElement("button"); minus.className='btn btn-red buzzer'; minus.textContent='‚àí';
    const countP=document.createElement("div"); countP.className='count'; countP.textContent = `+${it.pos} / -${it.neg}`;
    const plus=document.createElement("button"); plus.className='btn btn-green buzzer'; plus.textContent='+';
    minus.onclick=()=>{ it.neg++; countP.textContent = `+${it.pos} / -${it.neg}`; save(); };
    plus.onclick=()=>{ it.pos++; countP.textContent = `+${it.pos} / -${it.neg}`; save(); };
    ctr.append(minus,countP,plus);
    const levels = document.createElement("div"); levels.className="fmb";
    [["fragile","üî¥ Fragile"],["moyen","üü° Moyen"],["bon","üü¢ Bon"],["tb","üîµ Tr√®s bon"]].forEach(([v,lab])=>{
      const b=document.createElement("button"); b.textContent=lab; if(it.level===v) b.classList.add("active");
      b.onclick=()=>{ it.level=v; renderObserve(); save(); };
      levels.appendChild(b);
    });
    row.append(name, ctr, levels);
    cont.append(row);
  });
}
function renderBilan(){
  const team=(app.observers||[]).join(", ")||"‚Äî";
  $("bilanSubtitle").textContent = `Observateurs : ${team}`;
  $("bilanMeta").textContent = `Date : ${new Date().toLocaleDateString()}`;
  const cont=$("bilanContent"); cont.innerHTML="";
  if(!(app.observations||[]).length){
    cont.innerHTML = `<div class="print-card">Aucune observation enregistr√©e.</div>`;
    return;
  }
  app.observations.forEach((o,i)=>{
    const card=document.createElement("div"); card.className="print-card avoid-break";
    const h=document.createElement("div");
    h.innerHTML = `<b>${i+1}. ${o.champ} ‚Äî ${o.apsa}</b> ‚Ä¢ <span class="muted">${new Date(o.date).toLocaleString()}</span>`;
    const who=document.createElement("div"); who.className="muted";
    who.textContent = `Obs: ${(o.observers||[]).join(", ")||"‚Äî"} ‚Ä¢ Groupe: ${(o.group||[]).join(", ")||"‚Äî"}`;
    const ul=document.createElement("ul"); ul.style.margin="8px 0 0 16px";
    o.items.forEach(it=>{
      const li=document.createElement("li");
      const color = it.level==="fragile"?"red":it.level==="moyen"?"amber":it.level==="bon"?"green":"blue";
      li.innerHTML = `<span class="dot ${color}"></span>${it.text} ‚Äî +${it.pos} / -${it.neg} ‚Äî <i>${it.level}</i>`;
      ul.append(li);
    });
    card.append(h, who, ul);
    cont.append(card);
  });
}

/* ===== UI WIRING ===== */
document.addEventListener("DOMContentLoaded", ()=>{
  load();

  // Header buttons
  $("btnHelp").onclick = ()=> alert("1) Choisis CA/APSA et le contexte ‚Ä¢ 2) R√®gle tes observables ‚Ä¢ 3) Observe (+/-, 4 niveaux) ‚Ä¢ 4) Bilan ‚Üí Export PDF (impression iPad).");
  $("btnHardReset").onclick = hardReset;

  // nav cover -> choose
  $("goSetup").onclick = ()=> show("choose");

  // chips inputs
  $("obsInput").addEventListener("keydown",(e)=>{
    if(["Enter",",",";"].includes(e.key)){
      e.preventDefault();
      const arr = $("obsInput").value.replace(/\r\n?/g,"\n").split(/[ ,;\n]+/).map(s=>s.trim()).filter(Boolean);
      app.observers = Array.from(new Set([...(app.observers||[]), ...arr])); $("obsInput").value=""; save(); renderChoose();
    }
  });
  $("grpInput").addEventListener("keydown",(e)=>{
    if(["Enter",",",";"].includes(e.key)){
      e.preventDefault();
      const arr = $("grpInput").value.replace(/\r\n?/g,"\n").split(/[ ,;\n]+/).map(s=>s.trim()).filter(Boolean);
      app.group = Array.from(new Set([...(app.group||[]), ...arr])); $("grpInput").value=""; save(); renderChoose();
    }
  });

  // initial
  renderChoose(); show("cover");
});

/* Actions observables/observation */
$("backChoose").onclick = ()=> show("choose");
$("btnAddObs").onclick = ()=>{
  const v = $("newObs").value.trim(); if(!v) return;
  app.observables.push({text:v,pos:0,neg:0,level:"moyen"}); $("newObs").value=""; save(); renderObservables();
};
$("startObserve").onclick = ()=>{
  const items = app.observables.map(o=>({text:o.text, pos:0, neg:0, level:"moyen"}));
  app.current = {
    id: Math.random().toString(36).slice(2),
    date: new Date().toISOString(),
    champ: app.selected.champ, apsa: app.selected.apsa,
    observers: [...(app.observers||[])], group:[...(app.group||[])],
    items
  };
  save(); renderObserve(); show("observe");
};
$("obBack").onclick = ()=> show("observables");
$("obAdd").onclick = ()=>{
  const v = prompt("Nom de l'observable √† ajouter :"); if(!v) return;
  const it={text:v,pos:0,neg:0,level:"moyen"};
  app.current.items.push(it);
  app.observables.push({text:v,pos:0,neg:0,level:"moyen"});
  save(); renderObserve();
};
$("obToBilan").onclick = ()=>{
  if(app.current){
    app.observations.unshift(JSON.parse(JSON.stringify(app.current)));
    app.current = null; save();
  }
  renderBilan(); show("bilan");
};
$("bilanBack").onclick = ()=> show("observe");
$("bilanExportPDF").onclick = ()=> window.print();

function renderAll(){ renderChoose(); renderObservables(); renderObserve(); renderBilan(); }
</script>
</body>
</html>
