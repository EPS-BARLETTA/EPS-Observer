<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Choix activitÃ© â€¢ EPS Multiâ€‘Observer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./assets/style.css" />
  <script type="module">
    import {CHAMPS} from './assets/data.js';
    import {load, save, ensureApsaList} from './assets/app.js';
    const state = load();

    function renderChamps(){
      const grid = document.getElementById('champs'); grid.innerHTML="";
      CHAMPS.forEach(c=>{
        const sec = document.createElement('section'); sec.className="card";
        sec.innerHTML = `<div class="title">${c.id} â€” ${c.label}</div>`;
        const apsa = ensureApsaList(state, c.id);
        const g = document.createElement('div'); g.className="grid grid-4";
        apsa.forEach(name=>{
          const a=document.createElement('a'); a.className="tile"; a.href=`./observables.html?champ=${c.id}&apsa=${encodeURIComponent(name)}`;
          a.innerHTML = `<div class="big">${name}</div><div class="small">SÃ©lectionner</div>`;
          g.append(a);
        });
        const add = document.createElement('div'); add.className="tile";
        add.innerHTML = `<div class="big">âž• Ajouter une APSA</div><div class="small">Personnaliser cette EC</div>
                         <div class="row"><input id="inp-${c.id}" placeholder="Nom de l'APSA"><button class="btn btn-gray" id="btn-${c.id}">Ajouter</button></div>`;
        g.append(add);
        sec.append(g); grid.append(sec);
        add.querySelector(`#btn-${c.id}`).onclick = ()=>{
          const v = add.querySelector(`#inp-${c.id}`).value.trim();
          if(!v) return;
          const list = ensureApsaList(state, c.id);
          if(!list.includes(v)) list.push(v);
          save(state); renderChamps();
        };
      });
    }

    function setupContext(){
      const obsIn = document.getElementById('obs-in');
      const grpIn = document.getElementById('grp-in');
      obsIn.onkeydown = (e)=>{ if(e.key==="Enter"){ const arr = obsIn.value.split(/[ ,;]+/).filter(Boolean); state.observers = Array.from(new Set([...(state.observers||[]), ...arr])); obsIn.value=""; save(state); renderChips(); } };
      grpIn.onkeydown = (e)=>{ if(e.key==="Enter"){ const arr = grpIn.value.split(/[ ,;]+/).filter(Boolean); state.group = Array.from(new Set([...(state.group||[]), ...arr])); grpIn.value=""; save(state); renderChips(); } };
    }
    function renderChips(){
      const wrapObs=document.getElementById('chips-obs'); wrapObs.innerHTML="";
      (state.observers||[]).forEach((n,i)=>{
        const s=document.createElement('span'); s.className="badge"; s.textContent=n;
        const b=document.createElement('button'); b.className="btn btn-gray"; b.textContent="Ã—"; b.onclick=()=>{ state.observers.splice(i,1); save(state); renderChips(); };
        const w=document.createElement('span'); w.style.display="inline-flex"; w.style.alignItems="center"; w.style.gap="6px"; w.append(s,b);
        wrapObs.append(w);
      });
      const wrapGrp=document.getElementById('chips-grp'); wrapGrp.innerHTML="";
      (state.group||[]).forEach((n,i)=>{
        const s=document.createElement('span'); s.className="badge"; s.textContent=n;
        const b=document.createElement('button'); b.className="btn btn-gray"; b.textContent="Ã—"; b.onclick=()=>{ state.group.splice(i,1); save(state); renderChips(); };
        const w=document.createElement('span'); w.style.display="inline-flex"; w.style.alignItems="center"; w.style.gap="6px"; w.append(s,b);
        wrapGrp.append(w);
      });
    }

    window.addEventListener('DOMContentLoaded', ()=>{ setupContext(); renderChips(); renderChamps(); });
  </script>
</head>
<body>
<div class="app">
  <header class="header">
    <a class="btn btn-gray" href="./index.html">Accueil</a>
  </header>
  <main class="main">
    <section class="section">
      <div class="pageTitle">
        <h1>Choisir l'activitÃ©</h1>
        <div class="sub">1) Ajoute les observateurs et le groupe â€¢ 2) Choisis un champ puis une APSA</div>
      </div>
      <div class="row">
        <div class="col card">
          <div class="title">ðŸ‘€ ObservateurÂ·rice(s)</div>
          <input id="obs-in" placeholder="Tape un prÃ©nom puis EntrÃ©e" />
          <div class="row" id="chips-obs"></div>
        </div>
        <div class="col card">
          <div class="title">ðŸ‘¥ Groupe observÃ©</div>
          <input id="grp-in" placeholder="Tape un prÃ©nom puis EntrÃ©e" />
          <div class="row" id="chips-grp"></div>
        </div>
      </div>

      <div id="champs" style="margin-top:12px"></div>
    </section>
  </main>
  <footer class="footer">EPS Multiâ€‘Observer â€” SÃ©lection par CA â†’ APSA (ajout possible)</footer>
</div>
</body>
</html>
