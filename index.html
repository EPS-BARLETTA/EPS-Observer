<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
<meta charset="utf-8" />
<title>EPS Observer ‚Äî Monofichier (local)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --bg:#f6f8fb;--card:#fff;--text:#0f172a;--muted:#6b7280;--border:#e5e7eb;
    --green:#16a34a;--green-dark:#065f46;--red:#ef4444;--amber:#f59e0b;--blue:#2563eb;
    --shadow:0 2px 12px rgba(15,23,42,.06);
    --ca1:#ef4444; --ca2:#f59e0b; --ca3:#7c3aed; --ca4:#16a34a; --ca5:#06b6d4;
    --panel-observers:#dbeafe; --panel-group:#fff7ed;
    --panel-observers-border:#3b82f6; --panel-group-border:#f59e0b;
    --help1:#dbeafe; --help2:#dcfce7; --help3:#fee2e2; --help4:#ede9fe; --help5:#cffafe;
  }
  html[data-theme="dark"]{
    --bg:#0b1020; --card:#0f172a; --text:#e5e7eb; --muted:#a7b0c0; --border:#1f2937;
    --panel-observers:#10253f; --panel-group:#2a1c06; --panel-observers-border:#2563eb; --panel-group-border:#f59e0b;
    --shadow:0 2px 12px rgba(0,0,0,.35);
    --help1:#10253f; --help2:#0f3520; --help3:#3b0a0a; --help4:#1b143b; --help5:#07353a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
  .app{min-height:100dvh;display:flex;flex-direction:column}
  .header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);padding:10px 16px;display:flex;gap:8px;align-items:center;justify-content:space-between;z-index:10;box-shadow:var(--shadow)}
  .right{display:flex;gap:8px;align-items:center}
  .btn{border:0;border-radius:12px;padding:10px 16px;cursor:pointer;font-weight:700;letter-spacing:.2px;box-shadow:var(--shadow)}
  .btn-green{background:var(--green);color:#fff}
  .btn-green-dark{background:var(--green-dark);color:#fff}
  .btn-blue{background:var(--blue);color:#fff}
  .btn-gray{background:#e5e7eb;color:#111}
  html[data-theme="dark"] .btn-gray{background:#111827;color:#e5e7eb}
  .btn-red{background:#ef4444;color:#fff}
  .btn-amber{background:#f59e0b;color:#111}
  .btn-outline{background:var(--card);border:1px solid var(--border); color:var(--text)}
  .toggle{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:var(--card)}
  .main{flex:1;display:flex;align-items:center;justify-content:center;padding:24px}
  .section{width:min(1100px,95vw)}
  .pageTitle{text-align:center;margin:8px 0 20px}
  .pageTitle h1{font-size:34px;line-height:1.1;margin:0}
  .pageTitle .sub{color:var(--muted);font-size:14px;margin-top:6px}
  .hero{display:grid;place-items:center;height:70vh;text-align:center}
  .hero h1{font-size:56px;line-height:1.05;margin:0 0 8px}
  .hero p{color:var(--muted);font-size:18px;margin:0 0 28px}
  .start{font-size:18px;padding:14px 28px;border-radius:16px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 320px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:14px;box-shadow:var(--shadow)}
  .panel{position:relative;border-radius:18px;border:1px solid var(--border);padding:14px;background:var(--card);box-shadow:var(--shadow)}
  .panel.observers{background:var(--panel-observers);border-color:var(--panel-observers-border)}
  .panel.group{background:var(--panel-group);border-color:var(--panel-group-border)}
  .title{font-weight:800;margin-bottom:8px;display:flex;align-items:center;gap:10px}
  .muted{color:var(--muted);font-size:12px}
  input[type="text"],input[type="number"],textarea{width:100%;border:1px solid var(--border);border-radius:12px;padding:10px;font-size:16px;background:#fff;color:#111}
  html[data-theme="dark"] input[type="text"], html[data-theme="dark"] input[type="number"], html[data-theme="dark"] textarea{background:#111827;color:#e5e7eb;border-color:#374151}
  input::placeholder, textarea::placeholder{color:#9ca3af}
  textarea{min-height:84px;resize:vertical}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .chip{background:#eef2ff;color:#3730a3;border:1px solid #e0e7ff;border-radius:999px;padding:6px 10px;font-size:13px;display:inline-flex;gap:8px;align-items:center}
  html[data-theme="dark"] .chip{background:#1f2937;color:#c7d2fe;border-color:#374151}
  .chip button{border:0;background:transparent;cursor:pointer;color:#6b7280}
  .grid{display:grid;gap:10px}
  .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .grid-4{grid-template-columns:repeat(4,minmax(0,1fr))}
  .bar{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .seg{border:1px dashed var(--border);padding:8px;border-radius:12px;margin-top:8px;background:var(--card)}
  .tile{border:1px solid var(--border);border-radius:16px;padding:14px;background:var(--card);box-shadow:var(--shadow);text-decoration:none;color:inherit;display:flex;flex-direction:column;gap:6px;transition:transform .06s ease, box-shadow .12s ease}
  .tile .big{font-size:18px;font-weight:900}
  .tile .small{font-size:12px;color:#9ca3af}
  .tile:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(15,23,42,.10)}
  html[data-theme="dark"] .tile:hover{box-shadow:0 6px 18px rgba(0,0,0,.35)}
  .obs-item{display:grid;grid-template-columns: 1fr auto auto;gap:12px;align-items:center;border:1px solid var(--border);border-radius:12px;padding:12px;background:var(--card)}
  .obs-label{font-weight:900; padding:6px 10px; border:1px solid var(--border); border-radius:10px; background:#f8fafc; color:#0f172a}
  html[data-theme="dark"] .obs-label{background:#0b1220;color:#e5e7eb;border-color:#1f2937}
  .obs-hint{display:block; font-size:12px; color:#6b7280; margin-top:4px}
  .pmGroup{display:flex; align-items:center; gap:8px}
  .pmGroup .buzzer{width:64px;height:64px;border-radius:999px;font-size:28px;display:inline-flex;align-items:center;justify-content:center}
  .pmGroup .tally{min-width:64px; text-align:center; font-weight:900; border:1px solid var(--border); border-radius:10px; padding:10px 12px; background:#fff; color:#111;}
  html[data-theme="dark"] .pmGroup .tally{background:#111827;color:#e5e7eb;border-color:#374151}
  .pmGroup .corr{padding:8px 10px; border-radius:10px}
  .obs-extra{grid-column: 1 / -1; display:grid; gap:10px; grid-template-columns: 1fr 1fr; border:1px dashed var(--border); border-radius:10px; padding:8px; background:var(--card)}
  .fmb{display:flex; gap:10px; flex-wrap:wrap}
  .fmb button{border:0;border-radius:10px;padding:8px 10px;background:#e5e7eb;cursor:pointer;min-width:110px}
  .fmb button.active{outline:2px solid #111;outline-offset:2px;background:#fff}
  .note{width:100%; border:1px solid var(--border); border-radius:10px; padding:10px; font-size:14px}
  html[data-theme="dark"] .note{background:#111827;color:#e5e7eb;border-color:#374151}
  @media (max-width: 980px){ .obs-item{grid-template-columns:1fr} .obs-extra{grid-template-columns:1fr} }
  .optbar{display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin:8px 0 12px 0}
  .optbar .opt{display:flex; align-items:center; gap:6px; background:var(--card); border:1px solid var(--border); padding:8px 10px; border-radius:12px}
  .footer{border-top:1px solid var(--border);background:var(--card);padding:10px 16px;text-align:center;color:var(--muted);font-size:12px}
  .hidden{display:none}
  .chrono{display:flex; align-items:center; gap:10px; flex-wrap:wrap; background:var(--help1); border:1px solid var(--border); border-radius:14px; padding:10px 12px; box-shadow:var(--shadow); font-weight:800;}
  .chrono .time{min-width:220px; text-align:center; font-size:46px; letter-spacing:.5px; color:#2563eb}
  .chrono .ctrls{display:flex; gap:8px; align-items:center}
  .chrono .mode{display:flex; align-items:center; gap:8px}
  .chrono .mode .dur{width:120px}
  .laps{margin-top:8px}
  .lap{font-size:12px; color:#374151; background:#f3f4f6; border:1px solid #e5e7eb; border-radius:10px; padding:4px 8px; display:inline-flex; gap:8px; margin-right:6px; margin-bottom:6px}
  html[data-theme="dark"] .lap{color:#e5e7eb;background:#111827;border-color:#374151}
  .toast{position:fixed; left:50%; transform:translateX(-50%); top:14px; background:#111; color:#fff; padding:10px 14px; border-radius:999px; box-shadow:0 8px 24px rgba(0,0,0,.25); font-size:14px; z-index:50; opacity:0; pointer-events:none; transition:opacity .2s ease, transform .2s ease;}
  .toast.show{opacity:1; transform:translate(-50%,0)}
  .print-page{background:#fff;border:1px solid #e5e7eb;box-shadow:var(--shadow);padding:20px;border-radius:18px;-webkit-print-color-adjust: exact; print-color-adjust: exact; color-adjust: exact; color:#0f172a}
  .print-header{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:10px}
  .print-title{font-size:28px;font-weight:900;letter-spacing:.3px;color:#0f172a}
  .print-sub{color:#6b7280;font-size:12px}
  .print-card{border:1px solid #e5e7eb;border-radius:14px;padding:12px;margin-bottom:12px;background:#fff}
  .avoid-break{break-inside:avoid;page-break-inside:avoid}
  .dot{display:inline-block;width:10px;height:10px;border-radius:999px;margin-right:8px;vertical-align:baseline}
  .dot.red{background:#ef4444}.dot.amber{background:#f59e0b}.dot.green{background:#22c55e}.dot.darkgreen{background:#065f46}
  .ca-card{position:relative; overflow:hidden}
  .ca-card::before{content:""; position:absolute; inset:auto 0 0 0; height:6px; background:var(--ca-color); border-bottom-left-radius:16px; border-bottom-right-radius:16px;}
  .title .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:900; color:#fff; letter-spacing:.2px; background:var(--ca-color)}
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:60;padding:16px}
  .modal.show{display:flex}
  .modal-card{width:min(1000px,95vw);max-height:85vh;overflow:auto;background:var(--card);border-radius:18px;border:1px solid var(--border);padding:16px;box-shadow:var(--shadow)}
  .help-grid{display:grid; gap:12px; grid-template-columns:repeat(2,minmax(0,1fr))}
  .help-bloc{border:1px solid var(--border);border-radius:16px;padding:14px;background:var(--card)}
  .help-1{background:var(--help1)} .help-2{background:var(--help2)} .help-3{background:var(--help3)} .help-4{background:var(--help4)} .help-5{background:var(--help5)}
  @media (max-width: 860px){ .help-grid{grid-template-columns:1fr} }
  /* ‚úÖ rendre l‚Äô√©tat s√©lectionn√© visible en nuit */
  html[data-theme="dark"] .fmb button.active{
    background:#ffffff !important;color:#111 !important;border:1px solid #e5e7eb !important;
    outline:2px solid #e5e7eb !important; outline-offset:2px;
  }
  /* ‚úÖ masque la mention ¬´ Multi-groupes‚Ä¶ ¬ª sans changer le design */
  #page-observe .pageTitle .sub{display:none !important}
  /* ‚úÖ styles impression (PDF local) */
  @media print{
    body{background:#fff}
    .header,.footer,.nav,.toast,.modal{display:none !important}
    .main{padding:0}
    .section{width:auto}
    .print-page{border:0; box-shadow:none; padding:0}
    .avoid-break{page-break-inside:avoid}
    .print-card{page-break-inside:avoid; border-color:#ddd}
  }
</style>
</head>
<body>
<div class="app">
  <header class="header">
    <div class="toggle"><span>EPS Observer</span></div>
    <div class="right">
      <div class="toggle">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
          <input id="themeToggle" type="checkbox" /><span>Mode nuit</span>
        </label>
      </div>
      <button class="btn btn-amber" id="btnHelp">‚ùì Aide</button>
      <button class="btn btn-red" id="btnHardReset">‚ôªÔ∏è Reset</button>
    </div>
  </header>

  <main class="main">
    <section id="page-cover" class="section">
      <div class="hero">
        <div>
          <h1>EPS Observer</h1>
          <p>Tous champs CA1 √† CA5 & toutes APSA</p>
          <button class="btn btn-green start" id="goSetup">Commencer</button>
        </div>
      </div>
    </section>

    <section id="page-choose" class="section hidden">
      <div class="pageTitle">
        <h1>Activit√©</h1>
        <div class="sub">S√©lectionne un champ (CA1‚ÜíCA5), choisis une APSA (ou ajoute la tienne), puis le niveau.</div>
      </div>
      <div class="row">
        <div class="col">
          <div class="panel observers">
            <div class="title">üëÄ Observateur¬∑rice(s)</div>
            <input type="text" id="obsInput" placeholder="ex. Ambre, L√©o" />
            <div class="chips" id="obsChips"></div>
            <div class="muted">Entr√©e, virgule, point-virgule ou retour ligne pour ajouter.</div>
          </div>
        </div>
        <div class="col">
          <div class="panel group">
            <div class="title">üë• Groupe observ√© (par d√©faut)</div>
            <input type="text" id="grpInput" placeholder="ex. In√®s, L√©o" />
            <div class="chips" id="grpChips"></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="title">üß© Mode observation</div>
        <div class="row">
          <button class="btn btn-blue" id="btnNewObs">‚ûï Nouvelle observation (observ√©/observateur)</button>
          <button class="btn btn-gray" id="btnObsList">üìã Voir les observations (multi-tours)</button>
        </div>
      </div>

      <div id="champsGrid" class="grid" style="grid-template-columns:repeat(1,minmax(0,1fr)); gap:14px; margin-top:12px"></div>
    </section>

    <section id="page-observables" class="section hidden">
      <div class="pageTitle">
        <h1>Observables</h1>
        <div class="sub">APSA : <b id="obsAPSA">‚Äî</b> ‚Ä¢ Niveau : <b id="obsNiveau">N‚Äî</b></div>
      </div>
      <div class="card">
        <div id="obsList" class="grid"></div>
        <div class="row" style="margin-top:8px">
          <input id="newObs" placeholder="Ajouter un observable" />
          <button class="btn btn-blue" id="btnAddObs">‚ûï Ajouter</button>
        </div>
      </div>
      <div class="nav" style="margin-top:12px">
        <button class="btn btn-gray" id="backChoose">‚¨ÖÔ∏è Activit√©</button>
        <button class="btn btn-green" id="startObserve">D√©marrer l'observation ‚ñ∂Ô∏è</button>
      </div>
    </section>

    <section id="page-observe" class="section hidden">
      <div class="pageTitle" style="display:flex; align-items:flex-end; justify-content:space-between; gap:10px">
        <div>
          <h1 style="margin-bottom:4px">Observation ‚Äî <span id="titleAPSA">‚Äî</span> ‚Ä¢ <span id="titleNiveau">N‚Äî</span></h1>
          <div class="sub">Multi-groupes ‚Ä¢ +/‚àí corrigeables ‚Ä¢ Niveaux üî¥/üü°/üü¢/üü© ‚Ä¢ Notes libres ‚Ä¢ Laps & minuteur</div>
          <div class="optbar">
            <label class="opt"><input type="checkbox" id="optShowNotes" checked/> Champ libre</label>
            <label class="opt"><input type="checkbox" id="optShowLevels" checked/> Niveaux</label>
            <label class="opt"><input type="checkbox" id="optShowPM" checked/> Boutons +/-</label>
          </div>
          <div class="seg" id="groupsBar">
            <div class="bar">
              <div class="title">Groupes observ√©s</div>
              <div class="row">
                <button class="btn btn-blue" id="addGroup">‚ûï Ajouter un groupe</button>
                <button class="btn btn-amber" id="addObsTour">üïí Ajouter un tour d‚Äôobservation (observ√©/observateur)</button>
              </div>
            </div>
            <div id="groupsTabs" class="row" style="margin-top:8px"></div>
          </div>
        </div>
        <div>
          <div class="chrono">
            <span class="time" id="chronoTime">00:00:00</span>
            <div class="mode">
              <select id="chronoMode"><option value="chrono">Chrono</option><option value="timer">Minuteur</option></select>
              <input class="dur" id="chronoDur" type="time" step="1" />
            </div>
            <div class="ctrls">
              <button class="btn btn-outline" id="chronoStart">‚ñ∂Ô∏è Start</button>
              <button class="btn btn-outline" id="chronoLap">‚è± Tour</button>
              <button class="btn btn-outline" id="chronoPause">‚è∏ Stop</button>
              <button class="btn btn-outline" id="chronoReset">üîÑ Reset</button>
            </div>
          </div>
          <div class="laps" id="laps"></div>
        </div>
      </div>

      <div id="observeList" class="card"></div>

      <div class="nav">
        <button class="btn btn-gray" id="obBack">‚¨ÖÔ∏è Observables</button>
        <div class="row">
          <button class="btn btn-amber" id="obAdd">‚ûï Observable</button>
          <button class="btn btn-blue" id="obEnd">‚úÖ Terminer la session</button>
          <button class="btn btn-green" id="obToBilan">üìë Bilan</button>
        </div>
      </div>
    </section>

    <section id="page-bilan" class="section hidden">
      <div class="print-page" id="printRoot">
        <div class="print-header">
          <div class="print-sub" id="bilanMeta">Date : ‚Äî</div>
          <div class="print-sub" id="pdfAppName" style="color:#065f46; font-weight:900; letter-spacing:.2px; text-align:center; width:100%; font-size:16px">EPS Observer</div>
        </div>
        <div id="coverPreview" class="print-card avoid-break" style="text-align:center">
          <div style="font-size:54px; font-weight:900; margin-bottom:6px">Dossier d‚Äôobservation</div>
          <div id="coverObservers" style="font-size:54px; font-weight:900; margin-bottom:2px">‚Äî</div>
          <div id="coverDate" style="font-size:14px; color:#6b7280; margin-top:6px"></div>
        </div>
        <div id="bilanContent"></div>
        <div class="nav" style="margin-top:14px">
          <button class="btn btn-gray" id="bilanBack">‚¨ÖÔ∏è Retour</button>
          <div class="row">
            <button class="btn btn-green-dark" id="btnPrint">üñ®Ô∏è Imprimer / PDF</button>
            <button class="btn btn-blue" id="btnExportEleve">üìò Export √©l√®ve‚Ä¶</button>
            <button class="btn btn-amber" id="btnQRGlobal">üßæ QR global ScanProf</button>
          </div>
        </div>
      </div>
      <div class="footer">EPS Observer ‚Äì JB</div>
    </section>
  </main>

  <footer class="footer">EPS Observer ‚Äì √âquipe EPS Lyc√©e Vauban ‚Äì LUXEMBOURG ‚Äì JB</footer>
</div>

<!-- Modal Aide -->
<div class="modal" id="modalHelp">
  <div class="modal-card">
    <div class="bar" style="margin-bottom:8px">
      <h2 class="title" style="margin:0">üéì Aide ‚Äì Bien utiliser EPS Observer (local)</h2>
      <button class="btn btn-gray" id="helpClose">Fermer</button>
    </div>
    <div class="help-grid">
      <div class="help-bloc help-1">
        <div class="title">1Ô∏è‚É£ Choisir le champ & l‚ÄôAPSA</div>
        <p>Renseigne les <b>observateurs</b> et un <b>groupe par d√©faut</b>. S√©lectionne un <b>champ</b> (CA1‚ÜíCA5) et une <b>APSA</b> ou ajoute la tienne. Choisis un <b>niveau</b> (1‚Üí4) : les libell√©s s‚Äôadaptent.</p>
      </div>
      <div class="help-bloc help-2">
        <div class="title">2Ô∏è‚É£ Configurer les observables</div>
        <p>Active/supprime les <b>observables</b> propos√©s. Tu peux <b>ajouter</b> tes propres observables. Tout est <b>enregistr√©</b> dans l‚ÄôiPad (aucun envoi).</p>
      </div>
      <div class="help-bloc help-3">
        <div class="title">3Ô∏è‚É£ Observer</div>
        <p>Ajoute un ou plusieurs <b>groupes observ√©s</b>. Ou utilise le mode <b>Observation (observ√©/observateur)</b> pour multipliers les tours.</p>
      </div>
      <div class="help-bloc help-4">
        <div class="title">4Ô∏è‚É£ Chrono & minuteur</div>
        <p>Utilise le <b>chrono</b> (Start/Tour/Stop/Reset) ou la <b>roue de dur√©e</b> (minuteur). Les <b>tours</b> s‚Äôaffichent sous le chrono.</p>
      </div>
      <div class="help-bloc help-5">
        <div class="title">5Ô∏è‚É£ Bilan & PDF & QR</div>
        <p>Le bilan rassemble tout. Boutons : <b>Imprimer / PDF</b> (local iOS), <b>Export √©l√®ve</b>, <b>QR global ScanProf</b> (JSON multi-√©l√®ves).</p>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast">APSA s√©lectionn√©e</div>

<!-- ====== QRCode.js (minifi√©, int√©gr√© localement) ====== -->
<script>
/*! qrcodejs - minimal build (davidshimjs, CC0-like), r√©duit */
!function(o){function t(o){this.mode=f.MODE_8BIT_BYTE,this.data=o,this.parsedData=[];for(var t=0,n=this.data.length;t<n;t++){var e=[],r=this.data.charCodeAt(t);r>65536?(e[0]=240|(1835008&r)>>>18,e[1]=128|(258048&r)>>>12,e[2]=128|(4032&r)>>>6,e[3]=128|63&r):r>2048?(e[0]=224|(61440&r)>>>12,e[1]=128|(4032&r)>>>6,e[2]=128|63&r):r>128?(e[0]=192|(1984&r)>>>6,e[1]=128|63&r):e[0]=r,this.parsedData.push(e)}this.parsedData=Array.prototype.concat.apply([],this.parsedData)}function n(o,t){this.typeNumber=o,this.errorCorrectLevel=t,this.modules=null,this.moduleCount=0,this.dataCache=null,this.dataList=[]}function e(o,t){if(void 0==o.length)throw new Error(o.length+"/"+t);for(var n=0;n<o.length&&0==o[n];)n++;this.num=o.length-n,this.buf=new Array(this.num);for(var e=0;e<this.num;e++)this.buf[e]=o[e+n]}function r(o,t){this.totalCount=o,this.dataCount=t}function i(){this.buffer=[],this.length=0}function s(o,t){this.patternPosition=h.getPatternPosition(o),this.typeNumber=o,this.modules=null,this.moduleCount=0,this.dataCache=null,this.dataList=[],this.ecLevel=t||f.ErrorCorrectLevel.M}var f={};t.prototype.getLength=function(o){return this.parsedData.length},t.prototype.write=function(o){for(var t=0;t<this.parsedData.length;t++)o.put(this.parsedData[t],8)};var a={PAD0:236,PAD1:17,getRSBlocks:function(o,t){var n=a.getRsBlockTable(o,t);if(void 0==n)throw new Error("bad rs block @ typeNumber:"+o+"/errorCorrectLevel:"+t);for(var e=n.length/3,i=[],s=0;s<e;s++)for(var f=n[3*s+0],h=n[3*s+1],u=n[3*s+2],l=0;l<f;l++)i.push(new r(h,u));return i},getRsBlockTable:function(o,t){switch(t){case f.ErrorCorrectLevel.L:return c[4*o+0];case f.ErrorCorrectLevel.M:return c[4*o+1];case f.ErrorCorrectLevel.Q:return c[4*o+2];case f.ErrorCorrectLevel.H:return c[4*o+3];default:return void 0}}},h={PATTERN_POSITION_TABLE:[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54]],getPatternPosition:function(o){return h.PATTERN_POSITION_TABLE[o-1]},glog:function(o){if(o<1)throw new Error("glog("+o+")");return d[o]},gexp:function(o){for(;o<0;)o+=255;for(;o>=256;)o-=255;return p[o]}},u=function(o){for(var t=1,n=0;n<o;n++)t*=2;return t},l=Object.prototype.hasOwnProperty,c=function(){for(var o=new Array(0),t=1;t<=10;t++)o[4*t+0]=null,o[4*t+1]=null,o[4*t+2]=null,o[4*t+3]=null;return o}();f.ErrorCorrectLevel={L:1,M:0,Q:3,H:2},n.prototype.addData=function(o){var n=new t(o);this.dataList.push(n),this.dataCache=null},n.prototype.isDark=function(o,t){if(null==this.modules)throw new Error("modules not inited");return this.modules[o][t]},n.prototype.getModuleCount=function(){return this.moduleCount},n.prototype.make=function(){this.makeImpl(!1,this.getBestMaskPattern())},n.prototype.makeImpl=function(o,t){this.moduleCount=4*this.typeNumber+17,this.modules=new Array(this.moduleCount);for(var n=0;n<this.moduleCount;n++){this.modules[n]=new Array(this.moduleCount);for(var e=0;e<this.moduleCount;e++)this.modules[n][e]=null}this.setupPositionProbePattern(0,0),this.setupPositionProbePattern(this.moduleCount-7,0),this.setupPositionProbePattern(0,this.moduleCount-7),this.setupPositionAdjustPattern(),this.setupTimingPattern(),this.setupTypeInfo(o,t),this.setupTypeNumber(o),null==this.dataCache&&(this.dataCache=s.createData(this.typeNumber,this.errorCorrectLevel,this.dataList)),this.mapData(this.dataCache,t)},n.prototype.setupPositionProbePattern=function(o,t){for(var n=-1;n<=7;n++)if(!(o+n<=-1||this.moduleCount<=o+n))for(var e=-1;e<=7;e++)t+e<=-1||this.moduleCount<=t+e||(this.modules[o+n][t+e]=n>=0&&n<=6&&(0==e||6==e)||e>=0&&e<=6&&(0==n||6==n)||n>=2&&n<=4&&e>=2&&e<=4)},n.prototype.setupTimingPattern=function(){for(var o=8;o<this.moduleCount-8;o++)null==this.modules[o][6]&&(this.modules[o][6]=o%2==0);for(var t=8;t<this.moduleCount-8;t++)null==this.modules[6][t]&&(this.modules[6][t]=t%2==0)},n.prototype.setupPositionAdjustPattern=function(){for(var o=0,t=this.patternPosition.length;t>o;o++)for(var n=0,e=this.patternPosition.length;e>n;n++){var r=this.patternPosition[o],i=this.patternPosition[n];if(null==this.modules[r][i])for(var s=-2;2>=s;s++)for(var f=-2;2>=f;f++)this.modules[r+s][i+f]=-2==s||2==s||-2==f||2==f||0==s&&0==f}},n.prototype.setupTypeNumber=function(o){for(var t=h.getBCHTypeNumber(this.typeNumber),n=0;18>n;n++){var e=!o&&1==(t>>n&1);this.modules[Math.floor(n/3)][n%3+this.moduleCount-8-3]=e,this.modules[n%3+this.moduleCount-8-3][Math.floor(n/3)]=e}},n.prototype.setupTypeInfo=function(o,t){for(var n=h.getBCHTypeInfo(this.errorCorrectLevel<<3|t),e=0;15>e;e++){var r=!o&&1==(n>>e&1);6>e?this.modules[e][8]=r:8==e?this.modules[e+1][8]=r:9>e?this.modules[e+1][8]=r:this.modules[this.moduleCount-15+e][8]=r}for(e=0;15>e;e++){r=!o&&1==(n>>e&1);8>e?this.modules[8][this.moduleCount-e-1]=r:8==e?this.modules[8][this.moduleCount-e-1]=r:9>e?this.modules[8][this.moduleCount-e-1]=r:this.modules[8][14-e]=r}this.modules[this.moduleCount-8][8]=!o},n.prototype.mapData=function(o,t){for(var n=-1,e=this.moduleCount-1,r=7,i=0,s=this.moduleCount-1;s>0;s-=2)for(6==s&&s--;;){for(var f=0;2>f;f++)if(null==this.modules[s-f][e]){var a=!1;i<o.length&&(a=1==(o[i]>>>r&1));var h=this.getMask(t,s-f,e);this.modules[s-f][e]=h?a:!a,i++,r--,-1==r&&(r=7)}if(e+=n,0>e||this.moduleCount<=e){e-=n,n=-n;break}}},n.prototype.setupPositionProbePattern=n.prototype.setupPositionProbePattern,n.prototype.getBestMaskPattern=function(){for(var o=0,t=0,n=0;8>n;n++){this.makeImpl(!0,n);var e=h.getLostPoint(this);(0==n||o>e)&&(o=e,t=n)}return t},n.prototype.createMovieClip=function(o,t,n){var e=o.createEmptyMovieClip(t,n),r=1;this.make();for(var i=0;i<this.modules.length;i++)for(var s=1*this.modules.length,a=0;a<this.modules[i].length;a++){var f=e.createEmptyMovieClip("child"+i+"_"+a,0);f.beginFill(this.modules[i][a]?0:16777215,100),f.moveTo(a*r,i*r),f.lineTo(a*r+1,i*r),f.lineTo(a*r+1,i*r+1),f.lineTo(a*r,i*r+1),f.endFill()}return e},s.PAD0=236,s.PAD1=17,s.createData=function(o,t,r){for(var i=a.getRSBlocks(o,t),s=new i.constructor,f=0;f<r.length;f++){var h=r[f];s.put(h.mode,4),s.put(h.getLength(),8),h.write(s)}for(var u=0,l=0,c=0;c<i.length;c++)u+=i[c].dataCount,l+=i[c].totalCount;for(var d=new i.constructor,p=0;p<i.length;p++){var g=i[p].dataCount,m=r[p]&&r[p].getLength()?r[p].getLength():0;if(m>g)throw new Error("code length overflow. ("+m+">"+g+")")}for(var v=[],y=0;y<r.length;y++){var b=r[y];b.write(d)}for(var w=u-d.length(),k=0;k<w;k++)d.put(0,k%2?17:236);return function(o,t){for(var n=0,e=0,r=0,i=new Array(t),s=new Array(t),f=0;t>f;f++){var a=i[f]=o[f].dataCount,h=s[f]=o[f].totalCount-a;d=new Array(a);for(var u=0;a>u;u++)d[u]=255&y[r+u];r+=a;var l=h,c=m.getPolynomial(l),p=(new e(d,a)).mod(c);i[f].data=p.buf}for(var d,p,g=0,m=new function(o){if(void 0==o.length)throw new Error(o.length);for(var t=0;t<o.length&&0==o[t];)t++;this.num=o.length-t,this.buf=new Array(this.num);for(var n=0;n<this.num;n++)this.buf[n]=o[n+t]},v=0;v<i.length;v++)g=Math.max(g,i[v].buf.length);for(var b=[],w=0;w<g;w++)for(v=0;v<i.length;v++)w<i[v].buf.length&&b.push(i[v].buf[w]);return b}(i,l)};var d=new Array(256),p=new Array(256);for(var g=0;256>g;g++)p[g]=g<8?1<<g:p[g-1]^p[g-1]<<1^(128&p[g-1]?285:0),p[g]&=255;for(var g=0;256>g;g++){for(var m=0,u=1;u!=g;u=(u<<1^128&(u<<1)?285:0)&255)m++;d[g]=m}h.getBCHTypeInfo=function(o){for(var t=o<<10;h.getBCHDigit(t)-h.getBCHDigit(1335)>=0;)t^=1335<<h.getBCHDigit(t)-h.getBCHDigit(1335);return o<<10|t},h.getBCHTypeNumber=function(o){for(var t=o<<12;h.getBCHDigit(t)-h.getBCHDigit(7973)>=0;)t^=7973<<h.getBCHDigit(t)-h.getBCHDigit(7973);return o<<12|t},h.getBCHDigit=function(o){for(var t=0;0!=o;)t++,o>>>=1;return t},h.getMask=function(o,t,n){switch(o){case 0:return 0==(t+n)%2;case 1:return 0==t%2;case 2:return 0==n%3;case 3:return 0==(t+n)%3;case 4:return 0==(Math.floor(t/2)+Math.floor(n/3))%2;case 5:return 0==t*n%2+ t*n%3;case 6:return 0==(t*n%2+t*n%3)%2;case 7:return 0==(t*n%3+(t+n)%2)%2;default:throw new Error("bad maskPattern:"+o)}},h.getLostPoint=function(o){for(var t=o.getModuleCount(),n=0,e=0;t>e;e++)for(var r=0;t>r;r++){for(var i=0,s=o.isDark(e,r),f=-1;1>=f;f++)if(!(e+f<0||t<=e+f))for(var a=-1;1>=a;a++)r+a<0||t<=r+a||0==f&&0==a||s==o.isDark(e+f,r+a)&&i++;i>5&&(n+=3+i-5)}for(e=0;t-1>e;e++)for(r=0;t-1>r;r++){var u=0;o.isDark(e,r)&&u++,o.isDark(e+1,r)&&u++,o.isDark(e,r+1)&&u++,o.isDark(e+1,r+1)&&u++,(0==u||4==u)&&(n+=3)}for(e=0;t>e;e++)for(r=0;t-6>r;r++)o.isDark(e,r)&&!o.isDark(e,r+1)&&o.isDark(e,r+2)&&o.isDark(e,r+3)&&o.isDark(e,r+4)&&!o.isDark(e,r+5)&&o.isDark(e,r+6)&&(n+=40);for(r=0;t>r;r++)for(e=0;t-6>e;e++)o.isDark(e,r)&&!o.isDark(e+1,r)&&o.isDark(e+2,r)&&o.isDark(e+3,r)&&o.isDark(e+4,r)&&!o.isDark(e+5,r)&&o.isDark(e+6,r)&&(n+=40);for(var l=0,c=0,e=0;t>e;e++)for(r=0;t>r;r++)o.isDark(e,r)&&l++;return c=Math.abs(100*l/t/t-50)/5*10,n+=c},window.QRCode=function(o,t){(t=t||{}).text&&(t.text=""+t.text),this._el=o,this._htOption=t},QRCode.prototype.makeCode=function(o){this._htOption.text=o,this._oQRCode=null,this._oDrawing=null,this._el.innerHTML="";var t=this._htOption,n=new s( (t.typeNumber||4), f.ErrorCorrectLevel.M ); n.addData(t.text||""),n.make();var e=document.createElement("canvas"),r=e.getContext("2d"),i=t.width||256,c=t.height||256;e.width=i,e.height=c;for(var a=i/n.getModuleCount(),h=c/n.getModuleCount(),u=0;u<n.getModuleCount();u++)for(var l=0;l<n.getModuleCount();l++)r.fillStyle=n.isDark(u,l)?"#000":"#fff",r.fillRect(Math.round(l*a),Math.round(u*h),Math.ceil(a),Math.ceil(h));this._el.appendChild(e)} }(this);
</script>

<script>
/* =========================
   App monofichier (local)
   ========================= */
const APP_VERSION = "4.0.0-mono-local";
const REF_VERSION = "CCA-base-2025.02";

const CHAMPS = [
  { id:"CA1", color:"var(--ca1)", label:"R√©aliser une performance motrice maximale mesurable", baseAPSA:["Course de 1/2 fond","Course de relais","Combin√© athl√©tique","Natation de vitesse"]},
  { id:"CA2", color:"var(--ca2)", label:"Adapter son d√©placement √† des environnements vari√©s et incertains", baseAPSA:["Escalade","Course d‚Äôorientation","Sauvetage aquatique"]},
  { id:"CA3", color:"var(--ca3)", label:"Cr√©er et r√©aliser une prestation √† vis√©e artistique ou acrobatique", baseAPSA:["Danse contemporaine","Arts du cirque","Acrosport","Gymnastique au sol"]},
  { id:"CA4", color:"var(--ca4)", label:"Conduire et ma√Ætriser un affrontement individuel ou collectif", baseAPSA:["Badminton","Tennis de table","Boxe fran√ßaise","Basket-ball","Football","Handball","Rugby","Volley-ball","Judo"]},
  { id:"CA5", color:"var(--ca5)", label:"R√©aliser et orienter son activit√© physique pour entretenir sa sant√©", baseAPSA:["Course en dur√©e","Musculation","Natation en dur√©e","Step","Yoga"]},
];
const APSA_TO_CA = {}; for(const c of CHAMPS){ for(const a of c.baseAPSA) APSA_TO_CA[a] = c.id; }

const DEFAULT_OBS = {
  "Basket-ball":["Passe","Tir","Rebond","Aide d√©fensive"],
  "Football":["Passe","Tir","Pressing","Repli d√©fensif"],
  "Handball":["Passe","Tir","Bloc/d√©calage","Retour d√©fensif"],
  "Rugby":["Passe","Avanc√©e","Placage","Soutien"],
  "Volley-ball":["Service","R√©ception","Contre","Attaque"],
  "Badminton":["Service","Amorti","D√©gag√©","Smash"],
  "Tennis de table":["Service","Topspin","Remise","Bloc"],
  "Judo":["Saisie","D√©s√©quilibre","Projection","Immobilisation"],
  "Boxe fran√ßaise":["Direct","Fouett√©","Parade","Esquive"],
  "Escalade":["Lecture de voie","Appuis","Prises","Gestion de l‚Äôeffort"],
  "Course d‚Äôorientation":["Lecture carte","Choix itin√©raire","Pr√©cision poste","Gestion allure"],
  "Natation de vitesse":["D√©part","Fr√©quence/Amplitude","Virage","Arriv√©e"],
  "Natation en dur√©e":["Allure","Distance","R√©gularit√©","Technique"],
  "Course en dur√©e":["Allure","R√©gularit√©","FC/ressenti","Pacing"],
  "Musculation":["Technique","Charge","R√©p√©titions","R√©cup√©ration"],
  "Step":["Complexit√© des pas","Synchronisation","Rythme","S√©curit√©"],
  "Gymnastique au sol":["√âl√©ments","Liaisons","Amplitude","Tenue"],
  "Acrosport":["Port√©s","Voltige","S√©curit√©","Synchronisation"],
  "Danse contemporaine":["Intention","Espace","Temps","Qualit√© du mouvement"],
  "Arts du cirque":["Num√©ro","Ma√Ætrise objet","Risque contr√¥l√©","Pr√©sence"],
  "Combin√© athl√©tique":["Course","Saut","Lancer","Transitions"],
  "Course de 1/2 fond":["Allure","Relances","Gestion effort","Arriv√©e"],
  "Course de relais":["Transmission","Placement","Allure","Coordination"],
  "Sauvetage aquatique":["Immersion","Saisie","Remorquage","Gestion effort"],
  "Yoga":["Respiration","Alignement","Stabilit√©","Fluidit√©"]
};
const CA_LEVEL_HINTS = {
  CA1:{1:"D√©couverte / Allure de base",2:"R√©gularit√© & tenue",3:"Optimisation technique",4:"Strat√©gie & gestion d'effort"},
  CA2:{1:"S√©curit√© & rep√®res",2:"Choix simples",3:"Lecture/anticipation",4:"Optimisation itin√©raire/effort"},
  CA3:{1:"Ex√©cuter",2:"Encha√Æner",3:"Qualit√©/expressivit√©",4:"Intention & pr√©sence"},
  CA4:{1:"R√©gularit√© du geste",2:"Mettre en difficult√©",3:"Construire/finir",4:"Strat√©gie & lecture adverse"},
  CA5:{1:"Entrer dans l‚Äôeffort",2:"R√©gularit√© & contr√¥le",3:"Planification/auto-r√©gulation",4:"Optimisation sant√©/perf"}
};

const STORAGE_KEY = "eps_observer_v4_mono_local";
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(app)); }
function load(){ try{ const raw=localStorage.getItem(STORAGE_KEY); if(raw) Object.assign(app, JSON.parse(raw)); }catch{} }
function hardReset(){
  if(!confirm("Tout r√©initialiser ? (efface TOUTES les donn√©es locales)")) return;
  try{ if(app && app.timer && app.timer.handle){ clearInterval(app.timer.handle); app.timer.handle=null; } }catch(e){}
  try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
  location.reload();
}

function freshApp(){
  return {
    observers: [], groupDefault: [],
    champs: JSON.parse(JSON.stringify(CHAMPS)),
    selected: { champ:null, apsa:null, niveau:2 },
    observables: [],
    /* sessions classiques multi-groupes */
    session: null,
    /* historique des sessions (groupes) */
    observations: [],
    /* nouvelles observations collaboratives (observ√©/observateur, multi-tours) */
    obsTours: [], /* {id, observe, observateur, date, apsa, niveau, items[], commentaire} */
    settings:{ showNotes:true, showLevels:true, showPM:true, theme:"light" },
    timer:{mode:"chrono", running:false, start:0, elapsed:0, target:0, handle:null, laps:[]}
  };
}
const app = freshApp();
const $ = (id)=>document.getElementById(id);
const uid = ()=> Math.random().toString(36).slice(2);
let toastTimer=null;
function toast(msg){ const t=$("toast"); if(!t) return; t.textContent=msg; t.classList.add("show"); clearTimeout(toastTimer); toastTimer=setTimeout(()=>t.classList.remove("show"), 1600); }

/* ---------- chrono ---------- */
function timeInputToMs(){
  const val = $("chronoDur").value || "";
  const m = val.match(/^(\d{2}):(\d{2})(?::(\d{2}))?$/);
  if(!m) return 0;
  const h = parseInt(m[1]||"0",10), mn=parseInt(m[2]||"0",10), s=parseInt(m[3]||"0",10);
  return ((h*3600)+(mn*60)+s)*1000;
}
function formatHMS(ms){ ms = Math.max(0, ms|0); const h = Math.floor(ms/3600000); const m = Math.floor((ms%3600000)/60000); const s = Math.floor((ms%60000)/1000); return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }
function updateChrono(){
  const now=Date.now(); let cur=0;
  if(app.timer.mode==="chrono"){ cur = app.timer.running ? app.timer.elapsed + (now - app.timer.start) : app.timer.elapsed; }
  else { const spent = app.timer.running ? app.timer.elapsed + (now - app.timer.start) : app.timer.elapsed; cur = Math.max(0, app.timer.target - spent); if(app.timer.running && cur===0){ app.timer.running=false; if(app.timer.handle){ clearInterval(app.timer.handle); app.timer.handle=null; } toast("‚è±Ô∏è Temps √©coul√©"); } }
  $("chronoTime").textContent = formatHMS(cur);
}
function startChrono(){
  if(app.timer.running) return;
  if(app.timer.mode==="timer"){
    const t = timeInputToMs();
    if(t<=0){ alert("Renseigne une dur√©e valide (HH:MM:SS) pour le minuteur."); return; }
    if(app.timer.target !== t){ app.timer.target = t; app.timer.elapsed = 0; }
  }
  app.timer.running=true; app.timer.start=Date.now();
  app.timer.handle=setInterval(updateChrono,250);
  updateChrono();
}
function pauseChrono(){ if(!app.timer.running) return; app.timer.elapsed += Date.now() - app.timer.start; app.timer.running=false; if(app.timer.handle){ clearInterval(app.timer.handle); app.timer.handle=null; } updateChrono(); save(); }
function resetChrono(){ app.timer.running=false; app.timer.start=0; app.timer.elapsed=0; app.timer.target=(app.timer.mode==="timer")?timeInputToMs():0; app.timer.laps=[]; $("laps").innerHTML=""; if(app.timer.handle){ clearInterval(app.timer.handle); app.timer.handle=null; } updateChrono(); save(); }
function addLap(){ const text=$("chronoTime").textContent; const lapIdx=app.timer.laps.length+1; app.timer.laps.push(text); const span=document.createElement("span"); span.className="lap"; span.textContent=`Tour ${lapIdx}: ${text}`; $("laps").appendChild(span); save(); }

/* ---------- mod√®le observe ---------- */
function getHintFor(apsa, level){ const ca = APSA_TO_CA[apsa] || "CA4"; const arr = (CA_LEVEL_HINTS[ca]||{1:"D√©couverte",2:"Stabilisation",3:"Efficacit√©",4:"Exploitation"}); return arr[level] || arr[2]; }
function buildObservablesFor(apsa, niveau){ const base = DEFAULT_OBS[apsa] || ["Observable 1","Observable 2"]; const hint = getHintFor(apsa, niveau); return base.map(k=>({text:`${k} ‚Äî ${hint}`, pos:0,neg:0,level:"moyen",note:""})); }

function toChips(container, arr, onRemove){
  container.innerHTML = ""; (arr||[]).forEach((name, i)=>{ const s = document.createElement("span"); s.className = "chip"; s.innerHTML = `<span>${name}</span>`; const b = document.createElement("button"); b.textContent = "√ó"; b.onclick = ()=> onRemove(i); s.appendChild(b); container.appendChild(s); });
}
function show(which){ ["page-cover","page-choose","page-observables","page-observe","page-bilan"].forEach(id=>$(id).classList.add("hidden")); const map={cover:"page-cover", choose:"page-choose", observables:"page-observables", observe:"page-observe", bilan:"page-bilan"}; $(map[which]).classList.remove("hidden"); }

function renderChamps(){
  const grid = $("champsGrid"); grid.innerHTML = "";
  const lvlWrap = document.createElement("div");
  lvlWrap.className="card";
  lvlWrap.innerHTML = `<div class="title">üéöÔ∏è Niveau de ma√Ætrise (1 ‚Üí 4)</div>
    <div class="row">${[1,2,3,4].map(n=>`<button class="btn ${app.selected.niveau===n?'btn-green':'btn-gray'}" data-lvl="${n}">${n}</button>`).join("")}</div>`;
  lvlWrap.querySelectorAll("[data-lvl]").forEach(b=>b.onclick=()=>{
    app.selected.niveau=Number(b.getAttribute("data-lvl")); save();
    if(app.selected.apsa){ app.observables = buildObservablesFor(app.selected.apsa, app.selected.niveau); renderObservables(); if(app.session) renderObserve(); }
    renderChamps();
  });
  grid.appendChild(lvlWrap);

  CHAMPS.forEach(c=>{
    const sec = document.createElement("div"); sec.className="card ca-card";
    sec.style.setProperty('--ca-color', c.color);
    sec.innerHTML = `<div class="title"><span class="pill">${c.id}</span> <span>${c.label}</span></div>`;
    const g = document.createElement("div"); g.className = "grid grid-4";
    (c.baseAPSA||[]).forEach(name=>{
      const a = document.createElement("a");
      a.className="tile"; a.href="javascript:void(0)";
      a.innerHTML = `<div class="big">${name}</div><div class="small">S√©lectionner</div>`;
      a.onclick = ()=>{
        if(!confirmWipeIfSessionActive()) return;
        app.selected.champ=c.id; app.selected.apsa=name; save();
        app.observables = buildObservablesFor(app.selected.apsa, app.selected.niveau);
        toast(`APSA : ${name} ‚Ä¢ N${app.selected.niveau}`);
        renderObservables(); show("observables");
      };
      g.appendChild(a);
    });
    const add = document.createElement("div"); add.className="tile";
    add.innerHTML = `<div class="big">‚ûï Ajouter une APSA</div><div class="small">Personnaliser ce champ</div>
      <div class="row" style="margin-top:8px"><input placeholder="Nom de l'APSA" id="in-${c.id}"><button class="btn btn-gray" id="btn-${c.id}">Ajouter</button></div>`;
    g.appendChild(add);
    add.querySelector(`#btn-${c.id}`).onclick = ()=>{
      const v = add.querySelector(`#in-${c.id}`).value.trim(); if(!v) return;
      if(!confirmWipeIfSessionActive()) return;
      if(!c.baseAPSA.includes(v)) c.baseAPSA.push(v);
      APSA_TO_CA[v] = c.id;
      app.selected.champ=c.id; app.selected.apsa=v;
      app.observables = buildObservablesFor(v, app.selected.niveau);
      save(); renderChamps();
      toast(`APSA ajout√©e : ${v} ‚Ä¢ N${app.selected.niveau}`);
      renderObservables(); show("observables");
    };
    sec.appendChild(g); grid.appendChild(sec);
  });
}

function renderChoose(){
  toChips($("obsChips"), app.observers, (i)=>{ app.observers.splice(i,1); save(); renderChoose(); });
  toChips($("grpChips"), app.groupDefault, (i)=>{ app.groupDefault.splice(i,1); save(); renderChoose(); });
  renderChamps();
}

function renderObservables(){
  $("obsAPSA").textContent = app.selected.apsa || "‚Äî";
  $("obsNiveau").textContent = `N${app.selected.niveau}`;
  const list = $("obsList"); list.innerHTML="";
  (app.observables||[]).forEach((o,i)=>{
    const row = document.createElement("div"); row.className="seg";
    row.innerHTML = `<div><b>${o.text}</b></div>`;
    const del = document.createElement("button"); del.className="btn btn-gray"; del.textContent="Supprimer";
    del.style.marginTop="6px"; del.onclick = ()=>{ app.observables.splice(i,1); save(); renderObservables(); };
    row.appendChild(del); list.appendChild(row);
  });
}

/* === multi-groupes (h√©rite de ton code) === */
function renderGroupsTabs(){
  const tabs=$("groupsTabs"); tabs.innerHTML="";
  if(!app.session || !(app.session.groups||[]).length){
    tabs.innerHTML = `<span class="muted">Aucun groupe ‚Ä¢ utilise ‚Äú‚ûï Ajouter un groupe‚Äù.</span>`; return;
  }
  app.session.groups.forEach((g, idx)=>{
    const wrap=document.createElement("div"); wrap.className="row";
    const b=document.createElement("button");
    b.className="btn "+(app.session.activeGroupId===g.id?"btn-green":"btn-gray");
    b.textContent = (g.names||[]).join(", ") || `Groupe ${idx+1}`;
    b.onclick = ()=>{ app.session.activeGroupId = g.id; save(); renderObserve(); };
    wrap.appendChild(b);
    const rm=document.createElement("button"); rm.className="btn btn-outline"; rm.textContent="‚úñÔ∏é"; rm.title="Supprimer ce groupe";
    rm.onclick = ()=>{ if(!confirm("Supprimer ce groupe ?")) return; const i = app.session.groups.findIndex(x=>x.id===g.id); if(i>=0){ app.session.groups.splice(i,1); } if(app.session.activeGroupId===g.id){ app.session.activeGroupId = app.session.groups[0]?.id || null; } save(); renderGroupsTabs(); renderObserve(); };
    wrap.appendChild(rm);
    tabs.appendChild(wrap);
  });
}
function currentGroup(){ if(!app.session) return null; return app.session.groups.find(g=>g.id===app.session.activeGroupId) || null; }

function renderObserve(){
  $("titleAPSA").textContent = app.session?.apsa || app.selected.apsa || "‚Äî";
  $("titleNiveau").textContent = `N${app.session?.niveau || app.selected.niveau}`;
  renderGroupsTabs();
  const cont = $("observeList"); cont.innerHTML="";
  if(!app.session){ cont.innerHTML = `<div class="muted" style="padding:10px">Aucune session en cours.</div>`; return; }
  const g = currentGroup();
  if(!g){ cont.innerHTML = `<div class="muted" style="padding:10px">Ajoute un groupe √† observer.</div>`; return; }
  const showNotes = !!app.settings.showNotes;
  const showLevels = !!app.settings.showLevels;
  const showPM = !!app.settings.showPM;
  (g.items||[]).forEach((it, idx)=>{
    const row=document.createElement("div"); row.className="obs-item";
    const name=document.createElement("div");
    const [label, hint] = String(it.text).split(" ‚Äî ");
    name.innerHTML = `<span class="obs-label"><b>${label}</b></span>${hint?`<span class="obs-hint">N${app.session.niveau}: ${hint}</span>`:""}`;
    const colMinus=document.createElement("div"); colMinus.className="pmGroup";
    if(showPM){
      const btnMinus=document.createElement("button"); btnMinus.className='btn btn-red buzzer'; btnMinus.textContent='‚àí';
      const tallyMinus=document.createElement("div"); tallyMinus.className="tally"; tallyMinus.textContent = `-${it.neg}`;
      const corrMinus=document.createElement("button"); corrMinus.className='btn btn-outline corr'; corrMinus.textContent='corr. -';
      btnMinus.onclick=()=>{ it.neg++; tallyMinus.textContent = `-${it.neg}`; save(); };
      corrMinus.onclick=()=>{ if(it.neg>0){ it.neg--; tallyMinus.textContent = `-${it.neg}`; save(); } };
      colMinus.append(btnMinus, tallyMinus, corrMinus);
    }
    const colPlus=document.createElement("div"); colPlus.className="pmGroup";
    if(showPM){
      const corrPlus=document.createElement("button"); corrPlus.className='btn btn-outline corr'; corrPlus.textContent='corr. +';
      const tallyPlus=document.createElement("div"); tallyPlus.className="tally"; tallyPlus.textContent = `+${it.pos}`;
      const btnPlus=document.createElement("button"); btnPlus.className='btn btn-green buzzer'; btnPlus.textContent='+';
      btnPlus.onclick=()=>{ it.pos++; tallyPlus.textContent = `+${it.pos}`; save(); };
      corrPlus.onclick=()=>{ if(it.pos>0){ it.pos--; tallyPlus.textContent = `+${it.pos}`; save(); } };
      colPlus.append(corrPlus, tallyPlus, btnPlus);
    }
    row.append(name, colMinus, colPlus);
    if(showLevels || showNotes){
      const extra=document.createElement("div"); extra.className="obs-extra";
      const levels = document.createElement("div"); levels.className="fmb";
      if(showLevels){
        [["fragile","üî¥ Fragile"],["moyen","üü° Moyen"],["bon","üü¢ Bon"],["tb","üü© Tr√®s bon"]].forEach(([v,lab])=>{
          const b=document.createElement("button"); b.textContent=lab; if(it.level===v) b.classList.add("active");
          b.onclick=()=>{ it.level=v; renderObserve(); save(); };
          levels.appendChild(b);
        });
      }
      const noteWrap=document.createElement("div");
      if(showNotes){
        const input=document.createElement("input"); input.className="note"; input.placeholder="Note/temps (ex: 12''3, 1'05'', consigne‚Ä¶)"; input.value = it.note||""; input.oninput = (e)=>{ it.note = e.target.value; save(); };
        noteWrap.appendChild(input);
      }
      extra.append(levels, noteWrap); row.appendChild(extra);
    }
    cont.append(row);
  });
  const comCard=document.createElement("div"); comCard.className="card";
  comCard.innerHTML = `<div class="title">üí¨ Commentaire sur le groupe courant</div><textarea id="groupComment" placeholder="Observations, priorit√©s, conseils‚Ä¶"></textarea>`;
  const ta = comCard.querySelector("#groupComment"); ta.value = g.comment || ""; ta.oninput = (e)=>{ g.comment = e.target.value; save(); };
  cont.appendChild(comCard);
}

/* === Bilan (impression locale) === */
function renderBilan(){
  $("bilanMeta").textContent = `Date : ${new Date().toLocaleDateString()}`;
  $("coverDate").textContent = new Date().toLocaleDateString();
  const observersTxt = (app.session?.observers||app.observers||[]).join(", ") || "Observateurs";
  $("coverObservers").textContent = observersTxt;
  const cont=$("bilanContent"); cont.innerHTML="";
  const sess = app.session; if(!sess){ cont.innerHTML = `<div class="print-card">Aucune session en cours.</div>`; return; }
  (sess.groups||[]).forEach((g,gi)=>{
    const card=document.createElement("div"); card.className="print-card avoid-break";
    const h=document.createElement("div");
    h.innerHTML = `<b>Groupe ${gi+1}</b> ‚Äî ${(g.names||[]).join(", ")||"‚Äî"} ‚Ä¢ <span class="muted">${new Date(sess.date).toLocaleString()}</span> ‚Ä¢ <i>${sess.champ} ‚Äî ${sess.apsa} (N${sess.niveau})</i>`;
    const ul=document.createElement("ul"); ul.style.margin="8px 0 0 16px";
    (g.items||[]).forEach(it=>{
      const color = it.level==="fragile"?"red":it.level==="moyen"?"amber":it.level==="bon"?"green":"darkgreen";
      const note = (it.note||"").trim() ? ` ‚Äî <i>${it.note}</i>` : "";
      const [label, hint] = String(it.text).split(" ‚Äî ");
      const hintTxt = hint ? ` ‚Äî ${hint}` : "";
      const li=document.createElement("li");
      li.innerHTML = `<span class="dot ${color}"></span><b>${label}</b>${hintTxt} ‚Äî +${it.pos} / -${it.neg}${note}`;
      ul.appendChild(li);
    });
    card.append(h, ul);
    if ((g.comment||"").trim().length){ const cdiv=document.createElement("div"); cdiv.style.marginTop="8px"; cdiv.innerHTML = `<b>üí¨ Commentaire :</b> ${g.comment}`; card.appendChild(cdiv); }
    cont.append(card);
  });
}

/* === Export √©l√®ve (impression PDF individuelle par nom) === */
function exportAllForStudentPrompt(){
  const name = prompt("Nom (exact) de l‚Äô√©l√®ve √† exporter :", "");
  if(!name) return;
  // On affiche uniquement ses cartes (sans casser l‚Äôexistant) : impression s√©lective.
  const backupHTML = $("bilanContent").innerHTML;
  const sess = app.session;
  const keep = [];
  (sess?.groups||[]).forEach((g,gi)=>{
    if((g.names||[]).includes(name)){
      const div = document.createElement("div"); div.className="print-card avoid-break";
      div.innerHTML = `<b>${name}</b> ‚Äî <i>${sess.champ} ‚Äî ${sess.apsa} (N${sess.niveau})</i> ‚Ä¢ <span class="muted">${new Date(sess.date).toLocaleString()}</span>`;
      const ul=document.createElement("ul"); ul.style.margin="8px 0 0 16px";
      (g.items||[]).forEach(it=>{
        const note = (it.note||"").trim() ? ` ‚Äî <i>${it.note}</i>` : "";
        const [label, hint] = String(it.text).split(" ‚Äî ");
        const hintTxt = hint ? ` ‚Äî ${hint}` : "";
        const li=document.createElement("li");
        li.textContent = `${label}${hintTxt} ‚Äî +${it.pos}/-${it.neg}${note}`;
        ul.appendChild(li);
      });
      div.appendChild(ul);
      keep.push(div);
    }
  });
  if(!keep.length){ alert("Aucune observation trouv√©e pour "+name); return; }
  $("bilanContent").innerHTML = "";
  keep.forEach(k=>$("bilanContent").appendChild(k));
  window.print();
  // restore
  setTimeout(()=>{ $("bilanContent").innerHTML = backupHTML; }, 500);
}

/* === Observations collaboratives (observ√©/observateur, multi-tours) === */
function newObsTour(){
  if(!app.selected.apsa){ alert("Choisis d‚Äôabord une APSA."); return; }
  const observe = prompt("Nom de l‚Äô√©l√®ve observ√© :", "");
  if(!observe) return;
  const observateur = prompt("Nom de l‚Äôobservateur :", "");
  if(!observateur) return;
  const items = app.observables.map(o=>({text:o.text, pos:0,neg:0,level:"moyen",note:""}));
  app.obsTours.push({ id:uid(), observe, observateur, apsa:app.selected.apsa, niveau:app.selected.niveau, date:new Date().toISOString(), items, commentaire:"" });
  save();
  toast(`Observation d√©marr√©e : ${observe} (par ${observateur})`);
}

/* === QR Global ScanProf (JSON multi-√©l√®ves) ===
   Hypoth√®se compatible : ScanProf lit un JSON libre et d√©tecte les champs (nom, prenom, classe, sexe, vma, distance‚Ä¶).
   On exporte un objet : {app, version, eleves:[ {nom, prenom, classe, ... , observations:[...]} ] }
   NB : si tu veux changer les cl√©s, ajuste buildScanProfJSON().
*/
function parseIdentityFromName(full){
  // Permet "Pr√©nom Nom (Classe)" ou "Nom, Pr√©nom" ou juste "Nom"
  const m = String(full).match(/^\s*([A-Za-z√Ä-√ñ√ò-√∂√∏-√ø' -]+)\s+([A-Za-z√Ä-√ñ√ò-√∂√∏-√ø' -]+)(?:\s*\(([^)]+)\))?\s*$/);
  if(m) return { prenom:m[1].trim(), nom:m[2].trim(), classe:(m[3]||"").trim() };
  const m2 = String(full).split(","); if(m2.length===2) return { nom:m2[0].trim(), prenom:m2[1].trim(), classe:"" };
  return { nom:full.trim(), prenom:"", classe:"" };
}

function aggregateAllStudents(){
  const map = new Map(); // key = nom+prenom+classe
  // multi-groupes de la session en cours
  const s = app.session;
  if(s){
    (s.groups||[]).forEach(g=>{
      (g.names||[]).forEach(n=>{
        const id = parseIdentityFromName(n);
        const key = `${id.nom}|${id.prenom}|${id.classe}`;
        if(!map.has(key)) map.set(key, { ...id, sexe:"", vma:"", distance:"", vitesse:"", observations:[] });
        const entry = map.get(key);
        entry.observations.push({
          source:"groupe",
          apsa:s.apsa, niveau:s.niveau, date:s.date,
          observateur:(app.observers||[]).join(", ")||"",
          items:(g.items||[]).map(it=>({observable:it.text, pos:it.pos, neg:it.neg, level:it.level, note:it.note||""}))
        });
      });
    });
  }
  // observations collaboratives (observ√©/observateur)
  (app.obsTours||[]).forEach(o=>{
    const id = parseIdentityFromName(o.observe);
    const key = `${id.nom}|${id.prenom}|${id.classe}`;
    if(!map.has(key)) map.set(key, { ...id, sexe:"", vma:"", distance:"", vitesse:"", observations:[] });
    const entry = map.get(key);
    entry.observations.push({
      source:"obs-tour",
      apsa:o.apsa, niveau:o.niveau, date:o.date, observateur:o.observateur,
      items:(o.items||[]).map(it=>({observable:it.text, pos:it.pos, neg:it.neg, level:it.level, note:it.note||""}))
    });
  });
  return Array.from(map.values());
}

function buildScanProfJSON(){
  const eleves = aggregateAllStudents();
  return {
    app:"EPS Observer",
    version:APP_VERSION,
    // champ(s) libre(s) que ScanProf peut mapper : nom, prenom, classe, sexe, distance, vitesse, vma‚Ä¶
    eleves: eleves
  };
}

function showQRGlobal(){
  const data = buildScanProfJSON();
  const json = JSON.stringify(data);
  // QR container
  const wrap = document.createElement("div");
  wrap.className="modal show"; wrap.id="qrModal";
  wrap.innerHTML = `
    <div class="modal-card">
      <div class="bar" style="margin-bottom:8px">
        <h3 class="title" style="margin:0">üßæ QR global ScanProf</h3>
        <div class="row">
          <button class="btn btn-gray" id="btnCopyJSON">üìã Copier JSON</button>
          <button class="btn btn-green" id="btnCloseQR">Fermer</button>
        </div>
      </div>
      <div id="qrBox" style="display:grid;place-items:center;padding:14px"></div>
      <pre style="max-height:240px;overflow:auto;background:#0b1220;color:#e5e7eb;padding:10px;border-radius:12px">${json.replace(/</g,"&lt;")}</pre>
      <div class="muted">Astuce : scanne avec <b>ScanProf</b> (Scanner un QR) pour importer tous les √©l√®ves de la s√©ance.</div>
    </div>`;
  document.body.appendChild(wrap);
  const box = wrap.querySelector("#qrBox");
  const qr = new QRCode(box, { text: json, width: 300, height: 300 });
  wrap.querySelector("#btnCloseQR").onclick = ()=>{ wrap.remove(); };
  wrap.querySelector("#btnCopyJSON").onclick = ()=>{
    try{ navigator.clipboard.writeText(json); toast("JSON copi√©"); }catch(e){ alert("Copie impossible : "+e.message); }
  };
}

/* ---------- helpers ---------- */
function confirmWipeIfSessionActive(next){
  if(app.session && (app.session.groups?.length || app.observables?.length)){
    const ok = confirm("‚ö†Ô∏è Changer d‚Äôactivit√© va √©craser les informations non export√©es.\nPense √† exporter (PDF/QR) avant de continuer.\n\nContinuer quand m√™me ?");
    if(!ok) return false;
    app.session = null; save();
  }
  return true;
}

/* ---------- boot ---------- */
document.addEventListener("DOMContentLoaded", ()=>{
  load();
  document.documentElement.setAttribute("data-theme", app.settings.theme || "light");
  $("themeToggle").checked = (app.settings.theme==="dark");
  $("themeToggle").onchange = (e)=>{ app.settings.theme = e.target.checked ? "dark" : "light"; document.documentElement.setAttribute("data-theme", app.settings.theme); save(); };

  show("cover");
  $("btnHelp").onclick = ()=> toggleModal("modalHelp", true);
  $("helpClose").onclick = ()=> toggleModal("modalHelp", false);
  $("btnHardReset").onclick = hardReset;
  $("goSetup").onclick = ()=> show("choose");

  $("obsInput").addEventListener("keydown",(e)=>{ if(["Enter",",",";"].includes(e.key)){ e.preventDefault(); const arr = $("obsInput").value.replace(/\r\n?/g,"\n").split(/[ ,;\n]+/).map(s=>s.trim()).filter(Boolean); app.observers = Array.from(new Set([...(app.observers||[]), ...arr])); $("obsInput").value=""; save(); renderChoose(); }});
  $("grpInput").addEventListener("keydown",(e)=>{ if(["Enter",",",";"].includes(e.key)){ e.preventDefault(); const arr = $("grpInput").value.replace(/\r\n?/g,"\n").split(/[ ,;\n]+/).map(s=>s.trim()).filter(Boolean); app.groupDefault = Array.from(new Set([...(app.groupDefault||[]), ...arr])); $("grpInput").value=""; save(); renderChoose(); }});

  $("btnNewObs").onclick = ()=> newObsTour();
  $("btnObsList").onclick = ()=>{
    if(!(app.obsTours||[]).length){ alert("Aucune observation (observ√©/observateur) pour l‚Äôinstant."); return; }
    const lines = app.obsTours.map(o=>`${o.observe} ‚üµ ${o.observateur} ‚Ä¢ ${o.apsa} N${o.niveau} ‚Ä¢ ${new Date(o.date).toLocaleTimeString()}`).join("\n");
    alert(lines);
  };

  $("optShowNotes").onchange = (e)=>{ app.settings.showNotes = e.target.checked; save(); renderObserve(); };
  $("optShowLevels").onchange = (e)=>{ app.settings.showLevels = e.target.checked; save(); renderObserve(); };
  $("optShowPM").onchange     = (e)=>{ app.settings.showPM = e.target.checked; save(); renderObserve(); };

  $("chronoMode").onchange = (e)=>{ app.timer.mode = e.target.value; resetChrono(); save(); };
  $("chronoStart").onclick = ()=> startChrono();
  $("chronoPause").onclick = ()=> pauseChrono();
  $("chronoReset").onclick = ()=> resetChrono();
  $("chronoLap").onclick   = ()=> addLap();
  updateChrono();

  $("backChoose").onclick = ()=> show("choose");
  $("btnAddObs").onclick = ()=>{ const v = $("newObs").value.trim(); if(!v) return; app.observables.push({text:v,pos:0,neg:0,level:"moyen",note:""}); $("newObs").value=""; save(); renderObservables(); };
  $("startObserve").onclick = ()=>{
    const items = app.observables.map(o=>({text:o.text, pos:0, neg:0, level:"moyen", note:""}));
    app.session = { id: uid(), date: new Date().toISOString(), champ: app.selected.champ, apsa: app.selected.apsa, niveau: app.selected.niveau, observers: [...(app.observers||[])], groups: [], activeGroupId: null };
    if((app.groupDefault||[]).length){ const g = { id: uid(), names:[...app.groupDefault], items: JSON.parse(JSON.stringify(items)), comment:"" }; app.session.groups.push(g); app.session.activeGroupId = g.id; }
    save(); renderGroupsTabs(); renderObserve(); show("observe");
  };

  $("addGroup").onclick = ()=>{
    if(!app.session){ alert("D√©marre d‚Äôabord une session."); return; }
    const names = prompt("Noms du groupe (s√©par√©s par virgule) :", ""); if(names==null) return;
    const arr = names.split(",").map(s=>s.trim()).filter(Boolean);
    const items = app.observables.map(o=>({text:o.text, pos:0, neg:0, level:"moyen", note:""}));
    const g = { id: uid(), names: arr, items, comment:"" };
    app.session.groups.push(g); app.session.activeGroupId = g.id; save(); renderGroupsTabs(); renderObserve();
  };
  $("addObsTour").onclick = ()=> newObsTour();

  $("obBack").onclick = ()=> show("observables");
  $("obAdd").onclick = ()=>{ const v = prompt("Nom de l'observable √† ajouter :"); if(!v) return; const it={text:v,pos:0,neg:0,level:"moyen",note:""}; const g = currentGroup(); if(!g){ alert("Ajoute d‚Äôabord un groupe."); return; } g.items.push(it); app.observables.push({text:v,pos:0,neg:0,level:"moyen",note:""}); save(); renderObserve(); };
  $("obEnd").onclick = ()=>{ if(!app.session){ alert("Pas de session en cours."); return; } app.observations.unshift(JSON.parse(JSON.stringify(app.session))); save(); toast("Session enregistr√©e dans l‚Äôhistorique"); };
  $("obToBilan").onclick = ()=>{ renderBilan(); show("bilan"); };

  $("bilanBack").onclick = ()=> show("observe");
  $("btnPrint").onclick = ()=>{ renderBilan(); window.print(); };
  $("btnExportEleve").onclick = ()=> exportAllForStudentPrompt();
  $("btnQRGlobal").onclick = ()=> showQRGlobal();

  function toggleModal(id,open){ const el=document.getElementById(id); if(el) el.classList.toggle("show", !!open); }
  window.toggleModal = toggleModal;
  window.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='hidden') save(); });
  window.addEventListener('beforeunload', save);

  function renderAll(){ renderChoose(); renderObservables(); renderGroupsTabs(); renderObserve(); renderBilan(); }
  renderAll();
});
</script>
</body>
</html>
