<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
<meta charset="utf-8" />
<title>EPS Observer</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#f6f8fb;--card:#fff;--text:#0f172a;--muted:#6b7280;--border:#e5e7eb;
    --green:#16a34a;--green-dark:#065f46;--red:#ef4444;--amber:#f59e0b;--blue:#2563eb;
    --shadow:0 2px 12px rgba(15,23,42,.06);
    --ca1:#ef4444; --ca2:#f59e0b; --ca3:#7c3aed; --ca4:#16a34a; --ca5:#06b6d4;

    --panel-observers:#dbeafe; --panel-group:#fff7ed;
    --panel-observers-border:#3b82f6; --panel-group-border:#f59e0b;

    --help1:#dbeafe; --help2:#dcfce7; --help3:#fee2e2; --help4:#ede9fe; --help5:#cffafe;
  }
  html[data-theme="dark"]{
    --bg:#0b1020; --card:#0f172a; --text:#e5e7eb; --muted:#a7b0c0; --border:#1f2937;
    --panel-observers:#10253f; --panel-group:#2a1c06;
    --panel-observers-border:#2563eb; --panel-group-border:#f59e0b;
    --shadow:0 2px 12px rgba(0,0,0,.35);
    --help1:#10253f; --help2:#0f3520; --help3:#3b0a0a; --help4:#1b143b; --help5:#07353a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
  .app{min-height:100dvh;display:flex;flex-direction:column}
  .header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);padding:10px 16px;display:flex;gap:8px;align-items:center;justify-content:space-between;z-index:10;box-shadow:var(--shadow)}
  .right{display:flex;gap:8px;align-items:center}
  .btn{border:0;border-radius:12px;padding:10px 16px;cursor:pointer;font-weight:700;letter-spacing:.2px;box-shadow:var(--shadow)}
  .btn-green{background:var(--green);color:#fff}
  .btn-green-dark{background:var(--green-dark);color:#fff}
  .btn-blue{background:var(--blue);color:#fff}
  .btn-gray{background:#e5e7eb;color:#111}
  html[data-theme="dark"] .btn-gray{background:#111827;color:#e5e7eb}
  .btn-red{background:#ef4444;color:#fff}
  .btn-amber{background:#f59e0b;color:#111}
  .btn-outline{background:var(--card);border:1px solid var(--border); color:var(--text)}
  .toggle{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:var(--card)}
  .main{flex:1;display:flex;align-items:center;justify-content:center;padding:24px}
  .section{width:min(1100px,95vw)}
  .pageTitle{text-align:center;margin:8px 0 20px}
  .pageTitle h1{font-size:34px;line-height:1.1;margin:0}
  .pageTitle .sub{color:var(--muted);font-size:14px;margin-top:6px}
  .hero{display:grid;place-items:center;height:70vh;text-align:center}
  .hero h1{font-size:56px;line-height:1.05;margin:0 0 8px}
  .hero p{color:var(--muted);font-size:18px;margin:0 0 28px}
  .start{font-size:18px;padding:14px 28px;border-radius:16px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 320px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:14px;box-shadow:var(--shadow)}
  .panel{position:relative;border-radius:18px;border:1px solid var(--border);padding:14px;background:var(--card);box-shadow:var(--shadow)}
  .panel.observers{background:var(--panel-observers);border-color:var(--panel-observers-border)}
  .panel.group{background:var(--panel-group);border-color:var(--panel-group-border)}
  .title{font-weight:800;margin-bottom:8px;display:flex;align-items:center;gap:10px}
  .muted{color:var(--muted);font-size:12px}
  input[type="text"],input[type="number"],textarea{width:100%;border:1px solid var(--border);border-radius:12px;padding:10px;font-size:16px;background:#fff;color:#111}
  html[data-theme="dark"] input[type="text"], html[data-theme="dark"] input[type="number"], html[data-theme="dark"] textarea{background:#111827;color:#e5e7eb;border-color:#374151}
  input::placeholder, textarea::placeholder{color:#9ca3af}
  textarea{min-height:84px;resize:vertical}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .chip{background:#eef2ff;color:#3730a3;border:1px solid #e0e7ff;border-radius:999px;padding:6px 10px;font-size:13px;display:inline-flex;gap:8px;align-items:center}
  html[data-theme="dark"] .chip{background:#1f2937;color:#c7d2fe;border-color:#374151}
  .chip button{border:0;background:transparent;cursor:pointer;color:#6b7280}
  .grid{display:grid;gap:10px}
  .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .grid-4{grid-template-columns:repeat(4,minmax(0,1fr))}
  .bar{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .seg{border:1px dashed var(--border);padding:8px;border-radius:12px;margin-top:8px;background:var(--card)}
  .tile{border:1px solid var(--border);border-radius:16px;padding:14px;background:var(--card);box-shadow:var(--shadow);text-decoration:none;color:inherit;display:flex;flex-direction:column;gap:6px;transition:transform .06s ease, box-shadow .12s ease}
  .tile .big{font-size:18px;font-weight:900}
  .tile .small{font-size:12px;color:#9ca3af}
  .tile:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(15,23,42,.10)}
  html[data-theme="dark"] .tile:hover{box-shadow:0 6px 18px rgba(0,0,0,.35)}

  .obs-item{display:grid;grid-template-columns: 1fr auto auto;gap:12px;align-items:center;border:1px solid var(--border);border-radius:12px;padding:12px;background:var(--card)}
  .obs-label{font-weight:900; padding:6px 10px; border:1px solid var(--border); border-radius:10px; background:#f8fafc; color:#0f172a}
  html[data-theme="dark"] .obs-label{background:#0b1220;color:#e5e7eb;border-color:#1f2937}
  .obs-hint{display:block; font-size:12px; color:#6b7280; margin-top:4px}
  .pmGroup{display:flex; align-items:center; gap:8px}
  .pmGroup .buzzer{width:64px;height:64px;border-radius:999px;font-size:28px;display:inline-flex;align-items:center;justify-content:center}
  .pmGroup .tally{min-width:64px; text-align:center; font-weight:900; border:1px solid var(--border); border-radius:10px; padding:10px 12px; background:#fff; color:#111;}
  html[data-theme="dark"] .pmGroup .tally{background:#111827;color:#e5e7eb;border-color:#374151}
  .pmGroup .corr{padding:8px 10px; border-radius:10px}
  .obs-extra{grid-column: 1 / -1; display:grid; gap:10px; grid-template-columns: 1fr 1fr; border:1px dashed var(--border); border-radius:10px; padding:8px; background:var(--card)}
  .fmb{display:flex; gap:10px; flex-wrap:wrap}
  .fmb button{border:0;border-radius:10px;padding:8px 10px;background:#e5e7eb;cursor:pointer;min-width:110px}
  .fmb button.active{outline:2px solid #111;outline-offset:2px;background:#fff}
  .note{width:100%; border:1px solid var(--border); border-radius:10px; padding:10px; font-size:14px}
  html[data-theme="dark"] .note{background:#111827;color:#e5e7eb;border-color:#374151}
  @media (max-width: 980px){ .obs-item{grid-template-columns:1fr} .obs-extra{grid-template-columns:1fr} }

  .optbar{display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin:8px 0 12px 0}
  .optbar .opt{display:flex; align-items:center; gap:6px; background:var(--card); border:1px solid var(--border); padding:8px 10px; border-radius:12px}

  .footer{border-top:1px solid var(--border);background:var(--card);padding:10px 16px;text-align:center;color:var(--muted);font-size:12px}
  .hidden{display:none}

  .chrono{display:flex; align-items:center; gap:10px; flex-wrap:wrap; background:var(--help1); border:1px solid var(--border); border-radius:14px; padding:10px 12px; box-shadow:var(--shadow); font-weight:800;}
  .chrono .time{min-width:220px; text-align:center; font-size:46px; letter-spacing:.5px; color:#2563eb}
  html[data-theme="dark"] .chrono .time{color:#06b6d4}
  .chrono .ctrls{display:flex; gap:8px; align-items:center}
  .chrono .mode{display:flex; align-items:center; gap:8px}
  .chrono .mode .dur{width:120px}
  .laps{margin-top:8px}
  .lap{font-size:12px; color:#374151; background:#f3f4f6; border:1px solid #e5e7eb; border-radius:10px; padding:4px 8px; display:inline-flex; gap:8px; margin-right:6px; margin-bottom:6px}
  html[data-theme="dark"] .lap{color:#e5e7eb;background:#111827;border-color:#374151}

  .toast{position:fixed; left:50%; transform:translateX(-50%); top:14px; background:#111; color:#fff; padding:10px 14px; border-radius:999px; box-shadow:0 8px 24px rgba(0,0,0,.25); font-size:14px; z-index:50; opacity:0; pointer-events:none; transition:opacity .2s ease, transform .2s ease;}
  .toast.show{opacity:1; transform:translate(-50%,0)}

  .print-page{background:#fff;border:1px solid #e5e7eb;box-shadow:var(--shadow);padding:20px;border-radius:18px;-webkit-print-color-adjust: exact; print-color-adjust: exact; color-adjust: exact; color:#0f172a}
  .print-header{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:10px}
  .print-title{font-size:28px;font-weight:900;letter-spacing:.3px;color:#0f172a}
  .print-sub{color:#6b7280;font-size:12px}
  .print-card{border:1px solid #e5e7eb;border-radius:14px;padding:12px;margin-bottom:12px;background:#fff}
  .avoid-break{break-inside:avoid;page-break-inside:avoid}
  .dot{display:inline-block;width:10px;height:10px;border-radius:999px;margin-right:8px;vertical-align:baseline}
  .dot.red{background:#ef4444}.dot.amber{background:#f59e0b}.dot.green{background:#22c55e}.dot.darkgreen{background:#065f46}

  .ca-card{position:relative; overflow:hidden}
  .ca-card::before{content:""; position:absolute; inset:auto 0 0 0; height:6px; background:var(--ca-color); border-bottom-left-radius:16px; border-bottom-right-radius:16px;}
  .title .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:900; color:#fff; letter-spacing:.2px; background:var(--ca-color)}

  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:60;padding:16px}
  .modal.show{display:flex}
  .modal-card{width:min(1000px,95vw);max-height:85vh;overflow:auto;background:var(--card);border-radius:18px;border:1px solid var(--border);padding:16px;box-shadow:var(--shadow)}
  .help-grid{display:grid; gap:12px; grid-template-columns:repeat(2,minmax(0,1fr))}
  .help-bloc{border:1px solid var(--border);border-radius:16px;padding:14px;background:var(--card)}
  .help-1{background:var(--help1)} .help-2{background:var(--help2)} .help-3{background:var(--help3)} .help-4{background:var(--help4)} .help-5{background:var(--help5)}
  @media (max-width: 860px){ .help-grid{grid-template-columns:1fr} }

  /* √âcran plein QR */
  #qrFullscreen .modal-card{max-width:none; width: min(900px, 95vw); text-align:center}
  #qrCanvas{background:#fff; padding:16px; border-radius:12px}
  #qrInfo{color:#111; background:#fff; padding:8px 12px; display:inline-block; border-radius:999px; border:1px solid #e5e7eb; margin-top:8px}

  /* Nuit: √©tat actif tr√®s visible */
  html[data-theme="dark"] .fmb button.active{
    background:#ffffff !important; color:#111 !important;
    border:1px solid #e5e7eb !important; outline:2px solid #e5e7eb !important; outline-offset:2px;
  }
  @page{ size:A4; margin:14mm 12mm; }
  @media print{ .header,.nav,.no-print,.modal{display:none!important} body{background:#fff} }
</style>
</head>
<body>
<div class="app">
  <header class="header">
    <div class="toggle"><span>EPS Observer ‚Äì √âquipe EPS Lyc√©e Vauban ‚Äì Luxembourg ‚Äì JB</span></div>
    <div class="right">
      <div class="toggle">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
          <input id="themeToggle" type="checkbox" /><span>Mode nuit</span>
        </label>
      </div>
      <button class="btn btn-amber" id="btnHelp">‚ùì Aide</button>
      <button class="btn btn-red" id="btnHardReset">‚ôªÔ∏è Reset</button>
    </div>
  </header>

  <main class="main">
    <!-- PAGE 1 : COVER -->
    <section id="page-cover" class="section">
      <div class="hero">
        <div>
          <h1>EPS Observer</h1>
          <p>Tous champs CA1 √† CA5 & toutes APSA</p>
          <button class="btn btn-green start" id="goSetup">Commencer</button>
        </div>
      </div>
    </section>

    <!-- PAGE 2 : ACTIVIT√â -->
    <section id="page-choose" class="section hidden">
      <div class="pageTitle">
        <h1>Activit√©</h1>
        <div class="sub">S√©lectionne un champ (CA1‚ÜíCA5), une APSA (ou ajoute la tienne), puis Niveau 1‚Äì4 ou üéì Bac.</div>
      </div>
      <div class="row">
        <div class="col">
          <div class="panel observers">
            <div class="title">üëÄ Observateur¬∑rice(s)</div>
            <input type="text" id="obsInput" placeholder="ex. Ambre, L√©o" />
            <div class="chips" id="obsChips"></div>
            <div class="muted">Entr√©e, virgule, point-virgule ou retour ligne pour ajouter.</div>
          </div>
        </div>
        <div class="col">
          <div class="panel group">
            <div class="title">üë• Groupe observ√© (par d√©faut)</div>
            <input type="text" id="grpInput" placeholder="ex. In√®s, L√©o" />
            <div class="chips" id="grpChips"></div>
          </div>
        </div>
      </div>
      <div id="champsGrid" class="grid" style="grid-template-columns:repeat(1,minmax(0,1fr)); gap:14px; margin-top:12px"></div>
    </section>

    <!-- PAGE 3 : OBSERVABLES -->
    <section id="page-observables" class="section hidden">
      <div class="pageTitle">
        <h1>Observables</h1>
        <div class="sub">APSA : <b id="obsAPSA">‚Äî</b> ‚Ä¢ Niveau : <b id="obsNiveau">N‚Äî</b></div>
      </div>
      <div class="card">
        <div id="obsList" class="grid"></div>
        <div class="row" style="margin-top:8px">
          <input id="newObs" placeholder="Ajouter un observable" />
          <button class="btn btn-blue" id="btnAddObs">‚ûï Ajouter</button>
        </div>
      </div>
      <div class="nav" style="margin-top:12px">
        <button class="btn btn-gray" id="backChoose">‚¨ÖÔ∏è Activit√©</button>
        <button class="btn btn-green" id="startObserve">D√©marrer l'observation ‚ñ∂Ô∏è</button>
      </div>
    </section>

    <!-- PAGE 4 : OBSERVATION -->
    <section id="page-observe" class="section hidden">
      <div class="pageTitle" style="display:flex; align-items:flex-end; justify-content:space-between; gap:10px">
        <div>
          <h1 style="margin-bottom:4px">Observation ‚Äî <span id="titleAPSA">‚Äî</span> ‚Ä¢ <span id="titleNiveau">N‚Äî</span></h1>
          <div class="sub">Multi-groupes ‚Ä¢ +/‚àí corrigeables ‚Ä¢ Niveaux üî¥/üü°/üü¢/üü© ‚Ä¢ Notes libres ‚Ä¢ Laps & minuteur</div>
          <div class="optbar">
            <label class="opt"><input type="checkbox" id="optShowNotes" checked/> Champ libre</label>
            <label class="opt"><input type="checkbox" id="optShowLevels" checked/> Niveaux</label>
            <label class="opt"><input type="checkbox" id="optShowPM" checked/> Boutons +/-</label>
          </div>
          <div class="seg" id="groupsBar">
            <div class="bar">
              <div class="title">Groupes observ√©s</div>
              <div class="row"><button class="btn btn-blue" id="addGroup">‚ûï Ajouter un groupe</button></div>
            </div>
            <div id="groupsTabs" class="row" style="margin-top:8px"></div>
          </div>
        </div>
        <div>
          <div class="chrono">
            <span class="time" id="chronoTime">00:00:00</span>
            <div class="mode">
              <select id="chronoMode">
                <option value="chrono">Chrono</option>
                <option value="timer">Minuteur</option>
              </select>
              <input class="dur" id="chronoDur" type="time" step="1" />
            </div>
            <div class="ctrls">
              <button class="btn btn-outline" id="chronoStart">‚ñ∂Ô∏è Start</button>
              <button class="btn btn-outline" id="chronoLap">‚è± Tour</button>
              <button class="btn btn-outline" id="chronoPause">‚è∏ Stop</button>
              <button class="btn btn-outline" id="chronoReset">üîÑ Reset</button>
            </div>
          </div>
          <div class="laps" id="laps"></div>
        </div>
      </div>

      <div id="observeList" class="card"></div>

      <div class="nav">
        <button class="btn btn-gray" id="obBack">‚¨ÖÔ∏è Observables</button>
        <div class="row">
          <button class="btn btn-amber" id="obAdd">‚ûï Observable</button>
          <button class="btn btn-blue" id="obEnd">‚úÖ Terminer la session</button>
          <button class="btn btn-green" id="obToBilan">üìë Bilan</button>
        </div>
      </div>
    </section>

    <!-- PAGE 5 : BILAN -->
    <section id="page-bilan" class="section hidden">
      <div class="print-page" id="printRoot">
        <div class="print-header">
          <div class="print-sub" id="bilanMeta">Date : ‚Äî</div>
          <div class="print-sub" id="pdfAppName" style="color:#065f46; font-weight:900; letter-spacing:.2px; text-align:center; width:100%; font-size:16px">EPS Observer</div>
        </div>
        <div id="coverPreview" class="print-card avoid-break" style="text-align:center">
          <div style="font-size:54px; font-weight:900; margin-bottom:6px">Dossier d‚Äôobservation</div>
          <div id="coverObservers" style="font-size:54px; font-weight:900; margin-bottom:2px">‚Äî</div>
          <div id="coverDate" style="font-size:14px; color:#6b7280; margin-top:6px"></div>
        </div>
        <div id="bilanContent"></div>
        <div class="nav" style="margin-top:14px">
          <button class="btn btn-gray" id="bilanBack">‚¨ÖÔ∏è Retour</button>
          <div class="row">
            <button class="btn btn-green-dark" id="btnShowQR">üî≥ QR plein √©cran</button>
            <button class="btn btn-green" id="bilanExport">üñ®Ô∏è Imprimer / Export PDF</button>
          </div>
        </div>
      </div>
      <div class="footer">EPS Observer ‚Äì JB</div>
    </section>
  </main>

  <footer class="footer">EPS Observer ‚Äì √âquipe EPS Lyc√©e Vauban ‚Äì Luxembourg ‚Äì JB</footer>
</div>

<!-- AIDE -->
<div class="modal" id="modalHelp">
  <div class="modal-card">
    <div class="bar" style="margin-bottom:8px">
      <h2 class="title" style="margin:0">üéì Aide ‚Äì Bien utiliser EPS Observer</h2>
      <button class="btn btn-gray" id="helpClose">Fermer</button>
    </div>
    <div class="help-grid">
      <div class="help-bloc help-1">
        <div class="title">1Ô∏è‚É£ Choisir le champ & l‚ÄôAPSA</div>
        <p>Renseigne les <b>observateurs</b> et un <b>groupe par d√©faut</b>. Choisis un <b>champ</b> (CA1‚ÜíCA5) et une <b>APSA</b> ou ajoute la tienne. S√©lectionne le <b>niveau</b> (1‚Üí4) ou <b>üéì Bac</b>.</p>
      </div>
      <div class="help-bloc help-2">
        <div class="title">2Ô∏è‚É£ Configurer les observables</div>
        <p>Active/supprime les <b>observables</b> propos√©s (adapt√©s au niveau). Tu peux <b>ajouter</b> les tiens. Tout est <b>enregistr√© localement</b> (aucun envoi).</p>
      </div>
      <div class="help-bloc help-3">
        <div class="title">3Ô∏è‚É£ Observer</div>
        <p>Ajoute un ou plusieurs <b>groupes</b> (‚ÄúJ√©r√¥me‚Äù, ‚ÄúJ√©r√¥me 2‚Äù‚Ä¶). Par observable : <b>+</b>/<b>‚àí</b> corrigeables, choix du <b>niveau</b> et <b>note libre</b>.</p>
      </div>
      <div class="help-bloc help-4">
        <div class="title">4Ô∏è‚É£ Chrono & minuteur</div>
        <p>Utilise le <b>chrono</b> (Start/Tour/Stop/Reset) ou le <b>minuteur</b> (dur√©e HH:MM:SS). Les <b>tours</b> s‚Äôaffichent sous le chrono.</p>
      </div>
      <div class="help-bloc help-5">
        <div class="title">5Ô∏è‚É£ Bilan, QR, PDF</div>
        <p>Le bilan rassemble <b>tous les groupes</b> avec leurs observables et commentaires. Le <b>QR plein √©cran</b> (fond blanc) s‚Äôaffiche pour <b>ScanProf</b>. Utilise <b>Imprimer</b> pour exporter en PDF.</p>
      </div>
    </div>
  </div>
</div>

<!-- QR plein √©cran -->
<div class="modal" id="qrFullscreen">
  <div class="modal-card">
    <div class="bar" style="justify-content:space-between; align-items:center">
      <div class="title" style="margin:0">üì∏ Scannez avec ScanProf</div>
      <button class="btn btn-gray" id="qrClose">Fermer</button>
    </div>
    <canvas id="qrCanvas" width="640" height="640"></canvas>
    <div id="qrInfo">QR session ‚Äì aucun serveur, donn√©es locales uniquement</div>
  </div>
</div>

<div id="toast" class="toast">APSA s√©lectionn√©e</div>

<script>
/* ===================== Donn√©es de base ===================== */
const CHAMPS = [
  { id:"CA1", color:"var(--ca1)", label:"R√©aliser une performance motrice maximale mesurable", baseAPSA:["Course de 1/2 fond","Course de relais","Combin√© athl√©tique","Natation de vitesse"]},
  { id:"CA2", color:"var(--ca2)", label:"Adapter son d√©placement √† des environnements vari√©s et incertains", baseAPSA:["Escalade","Course d‚Äôorientation","Sauvetage aquatique"]},
  { id:"CA3", color:"var(--ca3)", label:"Cr√©er et r√©aliser une prestation √† vis√©e artistique ou acrobatique", baseAPSA:["Danse contemporaine","Arts du cirque","Acrosport","Gymnastique au sol"]},
  { id:"CA4", color:"var(--ca4)", label:"Conduire et ma√Ætriser un affrontement individuel ou collectif", baseAPSA:["Badminton","Tennis de table","Boxe fran√ßaise","Basket-ball","Football","Handball","Rugby","Volley-ball","Judo"]},
  { id:"CA5", color:"var(--ca5)", label:"R√©aliser et orienter son activit√© physique pour entretenir sa sant√©", baseAPSA:["Course en dur√©e","Musculation","Natation en dur√©e","Step","Yoga"]},
];
const APSA_TO_CA = {}; for(const c of CHAMPS){ for(const a of c.baseAPSA) APSA_TO_CA[a] = c.id; }

/* Observables par APSA (base) */
const DEFAULT_OBS = {
  "Basket-ball":["Passe","Tir","Rebond","Aide d√©fensive"],
  "Football":["Passe","Tir","Pressing","Repli d√©fensif"],
  "Handball":["Passe","Tir","Bloc/d√©calage","Retour d√©fensif"],
  "Rugby":["Passe","Avanc√©e","Placage","Soutien"],
  "Volley-ball":["Service","R√©ception","Contre","Attaque"],
  "Badminton":["Service","Amorti","D√©gag√©","Smash"],
  "Tennis de table":["Service","Topspin","Remise","Bloc"],
  "Judo":["Saisie","D√©s√©quilibre","Projection","Immobilisation"],
  "Boxe fran√ßaise":["Direct","Fouett√©","Parade","Esquive"],
  "Escalade":["Lecture de voie","Appuis","Prises","Gestion de l‚Äôeffort"],
  "Course d‚Äôorientation":["Lecture carte","Choix itin√©raire","Pr√©cision poste","Gestion allure"],
  "Natation de vitesse":["D√©part","Fr√©quence/Amplitude","Virage","Arriv√©e"],
  "Natation en dur√©e":["Allure","Distance","R√©gularit√©","Technique"],
  "Course en dur√©e":["Allure","R√©gularit√©","FC/ressenti","Pacing"],
  "Musculation":["Technique","Charge","R√©p√©titions","R√©cup√©ration"],
  "Step":["Complexit√© des pas","Synchronisation","Rythme","S√©curit√©"],
  "Gymnastique au sol":["√âl√©ments","Liaisons","Amplitude","Tenue"],
  "Acrosport":["Port√©s","Voltige","S√©curit√©","Synchronisation"],
  "Danse contemporaine":["Intention","Espace","Temps","Qualit√© du mouvement"],
  "Arts du cirque":["Num√©ro","Ma√Ætrise objet","Risque contr√¥l√©","Pr√©sence"],
  "Combin√© athl√©tique":["Course","Saut","Lancer","Transitions"],
  "Course de 1/2 fond":["Allure","Relances","Gestion effort","Arriv√©e"],
  "Course de relais":["Transmission","Placement","Allure","Coordination"],
  "Sauvetage aquatique":["Immersion","Saisie","Remorquage","Gestion effort"],
  "Yoga":["Respiration","Alignement","Stabilit√©","Fluidit√©"]
};
/* Hints niveaux (adapt√©s par CA) */
const CA_LEVEL_HINTS = {
  CA1:{1:"D√©couverte / Allure de base",2:"R√©gularit√© & tenue",3:"Optimisation technique",4:"Strat√©gie & gestion d'effort"},
  CA2:{1:"S√©curit√© & rep√®res",2:"Choix simples",3:"Lecture/anticipation",4:"Optimisation itin√©raire/effort"},
  CA3:{1:"Ex√©cuter",2:"Encha√Æner",3:"Qualit√©/expressivit√©",4:"Intention & pr√©sence"},
  CA4:{1:"R√©gularit√© du geste",2:"Mettre en difficult√©",3:"Construire/finir",4:"Strat√©gie & lecture adverse"},
  CA5:{1:"Entrer dans l‚Äôeffort",2:"R√©gularit√© & contr√¥le",3:"Planification/auto-r√©gulation",4:"Optimisation sant√©/perf"}
};

/* ===================== √âtat / Persistence ===================== */
const STORAGE_KEY = "eps_observer_final_v1";
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(app)); }
function load(){ try{ const raw=localStorage.getItem(STORAGE_KEY); if(raw) Object.assign(app, JSON.parse(raw)); }catch{} }
function hardReset(){
  if(!confirm("Tout r√©initialiser ? Cela efface TOUTES les donn√©es locales (observateurs, groupes, observables, sessions, QR).")) return;
  try{ if(app && app.timer && app.timer.handle){ clearInterval(app.timer.handle); app.timer.handle=null; } }catch(e){}
  try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
  Object.assign(app, freshApp());
  renderAll(); show("cover"); save();
}

function freshApp(){
  return {
    observers: [], groupDefault: [],
    champs: JSON.parse(JSON.stringify(CHAMPS)),
    selected: { champ:null, apsa:null, niveau:2, bac:false },
    observables: [],
    session: null, // {id,date,champ,apsa,niveau,bac,observers,groups:[{id,names,items,comment}]}
    settings:{ showNotes:true, showLevels:true, showPM:true, theme:"light" },
    timer:{mode:"chrono", running:false, start:0, elapsed:0, target:0, handle:null, laps:[]},
    sessionUID: null // pour QR (unique par session)
  };
}
const app = freshApp();
const $ = (id)=>document.getElementById(id);
const uid = ()=> Math.random().toString(36).slice(2);
let toastTimer=null;
function toast(msg){ const t=$("toast"); if(!t) return; t.textContent=msg; t.classList.add("show"); clearTimeout(toastTimer); toastTimer=setTimeout(()=>t.classList.remove("show"), 1500); }
function confirmWipeIfSessionActive(next){
  if(app.session && (app.session.groups?.length || app.observables?.length)){
    const ok = confirm("‚ö†Ô∏è Changer d‚Äôactivit√© va √©craser les infos non export√©es.\nPense √† exporter le PDF avant.");
    if(!ok) return false;
    app.session = null; save();
  }
  return true;
}

/* ===================== Chrono/Minuteur ===================== */
function timeInputToMs(){
  const val = $("chronoDur").value || "";
  const m = val.match(/^(\d{2}):(\d{2})(?::(\d{2}))?$/);
  if(!m) return 0;
  const h = parseInt(m[1]||"0",10), mn=parseInt(m[2]||"0",10), s=parseInt(m[3]||"0",10);
  return ((h*3600)+(mn*60)+s)*1000;
}
function formatHMS(ms){ ms = Math.max(0, ms|0); const h = Math.floor(ms/3600000); const m = Math.floor((ms%3600000)/60000); const s = Math.floor((ms%60000)/1000); return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }
function updateChrono(){
  const now=Date.now(); let cur=0;
  if(app.timer.mode==="chrono"){ cur = app.timer.running ? app.timer.elapsed + (now - app.timer.start) : app.timer.elapsed; }
  else { const spent = app.timer.running ? app.timer.elapsed + (now - app.timer.start) : app.timer.elapsed; cur = Math.max(0, app.timer.target - spent); if(app.timer.running && cur===0){ app.timer.running=false; if(app.timer.handle){ clearInterval(app.timer.handle); app.timer.handle=null; } toast("‚è±Ô∏è Temps √©coul√©"); } }
  $("chronoTime").textContent = formatHMS(cur);
}
function startChrono(){
  if(app.timer.running) return;
  if(app.timer.mode==="timer"){
    const t = timeInputToMs();
    if(t<=0){ alert("Renseigne une dur√©e valide (HH:MM:SS) pour le minuteur."); return; }
    if(app.timer.target !== t){ app.timer.target = t; app.timer.elapsed = 0; }
  }
  app.timer.running=true; app.timer.start=Date.now();
  app.timer.handle=setInterval(updateChrono,250);
  updateChrono();
}
function pauseChrono(){ if(!app.timer.running) return; app.timer.elapsed += Date.now() - app.timer.start; app.timer.running=false; if(app.timer.handle){ clearInterval(app.timer.handle); app.timer.handle=null; } updateChrono(); save(); }
function resetChrono(){ app.timer.running=false; app.timer.start=0; app.timer.elapsed=0; app.timer.target=(app.timer.mode==="timer")?timeInputToMs():0; app.timer.laps=[]; $("laps").innerHTML=""; if(app.timer.handle){ clearInterval(app.timer.handle); app.timer.handle=null; } updateChrono(); save(); }
function addLap(){ const text=$("chronoTime").textContent; const lapIdx=app.timer.laps.length+1; app.timer.laps.push(text); const span=document.createElement("span"); span.className="lap"; span.textContent=`Tour ${lapIdx}: ${text}`; $("laps").appendChild(span); save(); }

/* ===================== Observables & niveaux ===================== */
function getHintFor(apsa, level, bac){
  if(bac) return "Crit√®res certificatifs (Bac)"; // placeholder : raccorde √† tes fiches
  const ca = APSA_TO_CA[apsa] || "CA4";
  const arr = (CA_LEVEL_HINTS[ca]||{1:"D√©couverte",2:"Stabilisation",3:"Efficacit√©",4:"Exploitation"});
  return arr[level] || arr[2];
}
function buildObservablesFor(apsa, niveau, bac){
  const base = DEFAULT_OBS[apsa] || ["Observable 1","Observable 2"];
  const hint = getHintFor(apsa, niveau, bac);
  return base.map(k=>({text:`${k} ‚Äî ${hint}`, pos:0,neg:0,level:"moyen",note:""}));
}

/* ===================== UI Helpers ===================== */
function toChips(container, arr, onRemove){
  container.innerHTML = "";
  (arr||[]).forEach((name, i)=>{
    const s = document.createElement("span");
    s.className = "chip";
    s.innerHTML = `<span>${name}</span>`;
    const b = document.createElement("button");
    b.textContent = "√ó"; b.onclick = ()=> onRemove(i);
    s.appendChild(b); container.appendChild(s);
  });
}
function show(which){
  ["page-cover","page-choose","page-observables","page-observe","page-bilan"].forEach(id=>$(id).classList.add("hidden"));
  const map={cover:"page-cover", choose:"page-choose", observables:"page-observables", observe:"page-observe", bilan:"page-bilan"};
  $(map[which]).classList.remove("hidden");
}

/* ===================== Renders ===================== */
function renderChamps(){
  const grid = $("champsGrid"); grid.innerHTML = "";

  // Niveau & Bac
  const lvlWrap = document.createElement("div");
  lvlWrap.className="card";
  lvlWrap.innerHTML = `<div class="title">üéöÔ∏è Niveau de ma√Ætrise (1 ‚Üí 4) & üéì Bac</div>
    <div class="row">
      ${[1,2,3,4].map(n=>`<button class="btn ${(!app.selected.bac && app.selected.niveau===n)?'btn-green':'btn-gray'}" data-lvl="${n}">N${n}</button>`).join("")}
      <button class="btn ${app.selected.bac?'btn-green':'btn-gray'}" id="btnBac">üéì Bac</button>
    </div>`;
  lvlWrap.querySelectorAll("[data-lvl]").forEach(b=>b.onclick=()=>{
    app.selected.bac=false;
    app.selected.niveau=Number(b.getAttribute("data-lvl")); save();
    if(app.selected.apsa){
      app.observables = buildObservablesFor(app.selected.apsa, app.selected.niveau, app.selected.bac);
      renderObservables(); if(app.session) renderObserve();
    }
    renderChamps();
  });
  lvlWrap.querySelector("#btnBac").onclick = ()=>{
    app.selected.bac = true; save();
    if(app.selected.apsa){
      app.observables = buildObservablesFor(app.selected.apsa, app.selected.niveau, true);
      renderObservables(); if(app.session) renderObserve();
    }
    renderChamps();
  };
  grid.appendChild(lvlWrap);

  CHAMPS.forEach(c=>{
    const sec = document.createElement("div"); sec.className="card ca-card";
    sec.style.setProperty('--ca-color', c.color);
    sec.innerHTML = `<div class="title"><span class="pill">${c.id}</span> <span>${c.label}</span></div>`;
    const g = document.createElement("div"); g.className = "grid grid-4";
    (c.baseAPSA||[]).forEach(name=>{
      const a = document.createElement("a");
      a.className="tile"; a.href="javascript:void(0)";
      a.innerHTML = `<div class="big">${name}</div><div class="small">S√©lectionner</div>`;
      a.onclick = ()=>{
        if(!confirmWipeIfSessionActive()) return;
        app.selected.champ=c.id; app.selected.apsa=name; save();
        app.observables = buildObservablesFor(app.selected.apsa, app.selected.niveau, app.selected.bac);
        toast(`APSA : ${name} ‚Ä¢ ${app.selected.bac?'Bac':('N'+app.selected.niveau)}`);
        renderObservables(); show("observables");
      };
      g.appendChild(a);
    });
    const add = document.createElement("div"); add.className="tile";
    add.innerHTML = `<div class="big">‚ûï Ajouter une APSA</div><div class="small">Personnaliser ce champ</div>
      <div class="row" style="margin-top:8px"><input placeholder="Nom de l'APSA" id="in-${c.id}"><button class="btn btn-gray" id="btn-${c.id}">Ajouter</button></div>`;
    g.appendChild(add);
    add.querySelector(`#btn-${c.id}`).onclick = ()=>{
      const v = add.querySelector(`#in-${c.id}`).value.trim(); if(!v) return;
      if(!confirmWipeIfSessionActive()) return;
      if(!c.baseAPSA.includes(v)) c.baseAPSA.push(v);
      APSA_TO_CA[v] = c.id;
      app.selected.champ=c.id; app.selected.apsa=v;
      app.observables = buildObservablesFor(v, app.selected.niveau, app.selected.bac);
      save(); renderChamps();
      toast(`APSA ajout√©e : ${v} ‚Ä¢ ${app.selected.bac?'Bac':('N'+app.selected.niveau)}`);
      renderObservables(); show("observables");
    };
    sec.appendChild(g); grid.appendChild(sec);
  });
}
function renderChoose(){
  toChips($("obsChips"), app.observers, (i)=>{ app.observers.splice(i,1); save(); renderChoose(); });
  toChips($("grpChips"), app.groupDefault, (i)=>{ app.groupDefault.splice(i,1); save(); renderChoose(); });
  renderChamps();
}
function renderObservables(){
  $("obsAPSA").textContent = app.selected.apsa || "‚Äî";
  $("obsNiveau").textContent = app.selected.bac ? "üéì Bac" : `N${app.selected.niveau}`;
  const list = $("obsList"); list.innerHTML="";
  (app.observables||[]).forEach((o,i)=>{
    const row = document.createElement("div"); row.className="seg";
    row.innerHTML = `<div><b>${o.text}</b></div>`;
    const del = document.createElement("button"); del.className="btn btn-gray"; del.textContent="Supprimer";
    del.style.marginTop="6px"; del.onclick = ()=>{ app.observables.splice(i,1); save(); renderObservables(); };
    row.appendChild(del); list.appendChild(row);
  });
}
function renderGroupsTabs(){
  const tabs=$("groupsTabs"); tabs.innerHTML="";
  if(!app.session || !(app.session.groups||[]).length){
    tabs.innerHTML = `<span class="muted">Aucun groupe ‚Ä¢ utilise ‚Äú‚ûï Ajouter un groupe‚Äù.</span>`; return;
  }
  app.session.groups.forEach((g, idx)=>{
    const wrap=document.createElement("div"); wrap.className="row";
    const b=document.createElement("button");
    b.className="btn "+(app.session.activeGroupId===g.id?"btn-green":"btn-gray");
    b.textContent = (g.names||[]).join(", ") || `Groupe ${idx+1}`;
    b.onclick = ()=>{ app.session.activeGroupId = g.id; save(); renderObserve(); };
    wrap.appendChild(b);
    const rm=document.createElement("button"); rm.className="btn btn-outline"; rm.textContent="‚úñÔ∏é"; rm.title="Supprimer ce groupe";
    rm.onclick = ()=>{ if(!confirm("Supprimer ce groupe ?")) return; const i = app.session.groups.findIndex(x=>x.id===g.id); if(i>=0){ app.session.groups.splice(i,1); } if(app.session.activeGroupId===g.id){ app.session.activeGroupId = app.session.groups[0]?.id || null; } save(); renderGroupsTabs(); renderObserve(); };
    wrap.appendChild(rm);
    tabs.appendChild(wrap);
  });
}
function currentGroup(){ if(!app.session) return null; return app.session.groups.find(g=>g.id===app.session.activeGroupId) || null; }
function renderObserve(){
  $("titleAPSA").textContent = app.session?.apsa || app.selected.apsa || "‚Äî";
  $("titleNiveau").textContent = app.session?.bac ? "üéì Bac" : `N${app.session?.niveau || app.selected.niveau}`;
  renderGroupsTabs();
  const cont = $("observeList"); cont.innerHTML="";
  if(!app.session){ cont.innerHTML = `<div class="muted" style="padding:10px">Aucune session en cours.</div>`; return; }
  const g = currentGroup();
  if(!g){ cont.innerHTML = `<div class="muted" style="padding:10px">Ajoute un groupe √† observer.</div>`; return; }
  const showNotes = !!app.settings.showNotes;
  const showLevels = !!app.settings.showLevels;
  const showPM = !!app.settings.showPM;
  (g.items||[]).forEach((it, idx)=>{
    const row=document.createElement("div"); row.className="obs-item";
    const name=document.createElement("div");
    const [label, hint] = String(it.text).split(" ‚Äî ");
    name.innerHTML = `<span class="obs-label"><b>${label}</b></span>${hint?`<span class="obs-hint">${app.session.bac?'üéì ':''}${hint}</span>`:""}`;

    const colMinus=document.createElement("div"); colMinus.className="pmGroup";
    if(showPM){
      const btnMinus=document.createElement("button"); btnMinus.className='btn btn-red buzzer'; btnMinus.textContent='‚àí';
      const tallyMinus=document.createElement("div"); tallyMinus.className="tally"; tallyMinus.textContent = `-${it.neg}`;
      const corrMinus=document.createElement("button"); corrMinus.className='btn btn-outline corr'; corrMinus.textContent='corr. -';
      btnMinus.onclick=()=>{ it.neg++; tallyMinus.textContent = `-${it.neg}`; save(); };
      corrMinus.onclick=()=>{ if(it.neg>0){ it.neg--; tallyMinus.textContent = `-${it.neg}`; save(); } };
      colMinus.append(btnMinus, tallyMinus, corrMinus);
    }
    const colPlus=document.createElement("div"); colPlus.className="pmGroup";
    if(showPM){
      const corrPlus=document.createElement("button"); corrPlus.className='btn btn-outline corr'; corrPlus.textContent='corr. +';
      const tallyPlus=document.createElement("div"); tallyPlus.className="tally"; tallyPlus.textContent = `+${it.pos}`;
      const btnPlus=document.createElement("button"); btnPlus.className='btn btn-green buzzer'; btnPlus.textContent='+';
      btnPlus.onclick=()=>{ it.pos++; tallyPlus.textContent = `+${it.pos}`; save(); };
      corrPlus.onclick=()=>{ if(it.pos>0){ it.pos--; tallyPlus.textContent = `+${it.pos}`; save(); } };
      colPlus.append(corrPlus, tallyPlus, btnPlus);
    }
    row.append(name, colMinus, colPlus);

    if(showLevels || showNotes){
      const extra=document.createElement("div"); extra.className="obs-extra";
      const levels = document.createElement("div"); levels.className="fmb";
      if(showLevels){
        [["fragile","üî¥ Fragile"],["moyen","üü° Moyen"],["bon","üü¢ Bon"],["tb","üü© Very good"]].forEach(([v,lab])=>{
          const b=document.createElement("button"); b.textContent=lab; if(it.level===v) b.classList.add("active");
          b.onclick=()=>{ it.level=v; renderObserve(); save(); };
          levels.appendChild(b);
        });
      }
      const noteWrap=document.createElement("div");
      if(showNotes){
        const input=document.createElement("input"); input.className="note"; input.placeholder="Note/temps (ex: 12''3, 1'05'', consigne‚Ä¶)"; input.value = it.note||""; input.oninput = (e)=>{ it.note = e.target.value; save(); };
        noteWrap.appendChild(input);
      }
      extra.append(levels, noteWrap); row.appendChild(extra);
    }
    cont.append(row);
  });
  const comCard=document.createElement("div"); comCard.className="card";
  comCard.innerHTML = `<div class="title">üí¨ Commentaire sur le groupe courant</div><textarea id="groupComment" placeholder="Observations, priorit√©s, conseils‚Ä¶"></textarea>`;
  const ta = comCard.querySelector("#groupComment"); ta.value = g.comment || ""; ta.oninput = (e)=>{ g.comment = e.target.value; save(); };
  cont.appendChild(comCard);
}
function renderBilan(){
  $("bilanMeta").textContent = `Date : ${new Date().toLocaleDateString()}`;
  $("coverDate").textContent = new Date().toLocaleDateString();
  const observersTxt = (app.session?.observers||app.observers||[]).join(", ") || "Observateurs";
  $("coverObservers").textContent = observersTxt;
  const cont=$("bilanContent"); cont.innerHTML="";
  const sess = app.session; if(!sess){ cont.innerHTML = `<div class="print-card">Aucune session en cours.</div>`; return; }
  (sess.groups||[]).forEach((g,gi)=>{
    const card=document.createElement("div"); card.className="print-card avoid-break";
    const h=document.createElement("div");
    h.innerHTML = `<b>Groupe ${gi+1}</b> ‚Äî ${(g.names||[]).join(", ")||"‚Äî"} ‚Ä¢ <span class="muted">${new Date(sess.date).toLocaleString()}</span> ‚Ä¢ <i>${sess.champ} ‚Äî ${sess.apsa} (${sess.bac?'üéì Bac':('N'+sess.niveau)})</i>`;
    const ul=document.createElement("ul"); ul.style.margin="8px 0 0 16px";
    (g.items||[]).forEach(it=>{
      const color = it.level==="fragile"?"red":it.level==="moyen"?"amber":it.level==="bon"?"green":"darkgreen";
      const note = (it.note||"").trim() ? ` ‚Äî <i>${it.note}</i>` : "";
      const [label, hint] = String(it.text).split(" ‚Äî ");
      const hintTxt = hint ? ` ‚Äî ${hint}` : "";
      const li=document.createElement("li");
      li.innerHTML = `<span class="dot ${color}"></span><b>${label}</b>${hintTxt} ‚Äî +${it.pos} / -${it.neg}${note}`;
      ul.appendChild(li);
    });
    card.append(h, ul);
    if ((g.comment||"").trim().length){ const cdiv=document.createElement("div"); cdiv.style.marginTop="8px"; cdiv.innerHTML = `<b>üí¨ Commentaire :</b> ${g.comment}`; card.appendChild(cdiv); }
    cont.append(card);
  });
}

/* ===================== QR code (inline, sans CDN) ===================== */
/* Micro-impl√©mentation QR type-2 (basique) adapt√©e canvas
   NB: pour la prod lourde, pr√©f√©rer une lib compl√®te ; ici, on encode en Byte + niveau L */
(function(){
  // Mini QR generator (version automatique, ECC-L, data < ~1.2KB suffisant pour notre JSON)
  // Adapt√© d'ideas publiques (qrcode.js) mais fortement r√©duit et inlined.
  // Pour garder la r√©ponse compacte, on ne commente pas toutes les lignes.
  const QR8bitByte=function(data){this.mode=4;this.data=data;this.parsed=[];for(let i=0;i<data.length;i++)this.parsed.push(data.charCodeAt(i));this.getLength=function(){return this.parsed.length};this.write=function(buffer){for(let i=0;i<this.parsed.length;i++)buffer.put(this.parsed[i],8)}};
  const QRMath={glog:function(n){if(n<1)throw new Error("glog("+n+")");return QRMath.LOG_TABLE[n]},gexp:function(n){for(;n<0;)n+=255;for(;n>=256;)n-=255;return QRMath.EXP_TABLE[n]},EXP_TABLE:new Array(256),LOG_TABLE:new Array(256)};
  for(let i=0;i<8;i++)QRMath.EXP_TABLE[i]=1<<i;for(let i=8;i<256;i++)QRMath.EXP_TABLE[i]=QRMath.EXP_TABLE[i-4]^QRMath.EXP_TABLE[i-5]^QRMath.EXP_TABLE[i-6]^QRMath.EXP_TABLE[i-8];
  for(let i=0;i<256;i++)QRMath.LOG_TABLE[QRMath.EXP_TABLE[i]]=i;
  const QRRSBlock={getRSBlocks:function(ver,ec){if(ec!="L")ec="L";const table=QRRSBlock.RS_BLOCK_TABLE[ver];const list=[];for(let i=0;i<table.length;i+=3){const count=table[i];const total=table[i+1];const data=table[i+2];for(let j=0;j<count;j++)list.push(new QRRSBlock(total,data))}return list},RS_BLOCK_TABLE:[
    // ver:1..10 (suffisant ici). Format: [count, totalCount, dataCount, ...] pour ECC L
    null,
    [1,26,19],          //1-L
    [1,44,34],          //2-L
    [1,70,55],          //3-L
    [1,100,80],         //4-L
    [1,134,108],        //5-L
    [2,86,68],          //6-L
    [2,98,78],          //7-L
    [2,121,97],         //8-L
    [2,146,116],        //9-L
    [2,86,68]           //10-L (placeholder simple)
  ]};
  function QRRSBlock(totalCount,dataCount){this.totalCount=totalCount;this.dataCount=dataCount}
  const QRBitBuffer=function(){this.buffer=[];this.length=0;this.get=function(i){return((this.buffer[Math.floor(i/8)]>>>(7-i%8))&1)==1};this.put=function(num,length){for(let i=0;i<length;i++)this.putBit(((num>>>(length-i-1))&1)==1)};this.putBit=function(bit){this.buffer[Math.floor(this.length/8)]|=(bit?1:0)<<(7-this.length%8);this.length++}};
  const QRPolynomial=function(num,shift){let offset=0;while(offset<num.length&&num[offset]==0)offset++;this.num=new Array(num.length-offset+shift);for(let i=0;i<num.length-offset;i++)this.num[i]=num[i+offset];};
  QRPolynomial.prototype.getAt=function(i){return this.num[i]}
  QRPolynomial.prototype.getLength=function(){return this.num.length}
  QRPolynomial.prototype.multiply=function(e){const num=new Array(this.getLength()+e.getLength()-1);for(let i=0;i<num.length;i++)num[i]=0;for(let i=0;i<this.getLength();i++){for(let j=0;j<e.getLength();j++){num[i+j]^=QRMath.gexp(QRMath.glog(this.getAt(i))+QRMath.glog(e.getAt(j)))}}return new QRPolynomial(num,0)}
  QRPolynomial.prototype.mod=function(e){if(this.getLength()-e.getLength()<0)return this;const ratio=QRMath.glog(this.getAt(0))-QRMath.glog(e.getAt(0));const num=new Array(this.getLength());for(let i=0;i<this.getLength();i++)num[i]=this.getAt(i);for(let i=0;i<e.getLength();i++)num[i]^=QRMath.gexp(QRMath.glog(e.getAt(i))+ratio);return new QRPolynomial(num,0).mod(e)}
  const QRUtil={PATTERN_POSITION_TABLE:[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54]],
    getPatternPosition:function(typeNumber){return QRUtil.PATTERN_POSITION_TABLE[typeNumber]},
    getBCHTypeInfo:function(data){let d=data<<10;while(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(1335)>=0){d^=(1335<<(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(1335)))}return((data<<10)|d)^21522},
    getBCHDigit:function(data){let digit=0;while(data!=0){digit++;data>>>=1}return digit},
    getMask:function(maskPattern,i,j){switch(maskPattern){case 0:return (i+j)%2==0;case 1:return i%2==0;case 2:return j%3==0;case 3:return (i+j)%3==0;case 4:return (Math.floor(i/2)+Math.floor(j/3))%2==0;case 5:return ((i*j)%2)+((i*j)%3)==0;case 6:return (((i*j)%2)+((i*j)%3))%2==0;case 7:return (((i+j)%2)+((i*j)%3))%2==0;default:throw new Error("bad mask")}},
    getErrorCorrectPolynomial:function(ecc){let a=new QRPolynomial([1],0);for(let i=0;i<ecc;i++)a=a.multiply(new QRPolynomial([1,QRMath.gexp(i)],0));return a},
    getLengthInBits:function(mode,type){if(type<10){if(mode==4)return 8;else return 8}return 8},
    getLostPoint:function(qr){let moduleCount=qr.getModuleCount();let lostPoint=0;for(let row=0;row<moduleCount;row++){for(let col=0;col<moduleCount;col++){let sameCount=0;let dark=qr.isDark(row,col);for(let r=-1;r<=1;r++){if(row+r<0||moduleCount<=row+r)continue;for(let c=-1;c<=1;c++){if(col+c<0||moduleCount<=col+c)continue;if(r==0&&c==0)continue;if(dark==qr.isDark(row+r,col+c))sameCount++}}if(sameCount>5)lostPoint+=(3+sameCount-5)}}
      for(let row=0;row<moduleCount-1;row++){for(let col=0;col<moduleCount-1;col++){let count=0;if(qr.isDark(row,col))count++;if(qr.isDark(row+1,col))count++;if(qr.isDark(row,col+1))count++;if(qr.isDark(row+1,col+1))count++;if(count==0||count==4)lostPoint+=3}}
      for(let row=0;row<moduleCount;row++){for(let col=0;col<moduleCount-6;col++){if(qr.isDark(row,col)&&!qr.isDark(row,col+1)&&qr.isDark(row,col+2)&&qr.isDark(row,col+3)&&qr.isDark(row,col+4)&&!qr.isDark(row,col+5)&&qr.isDark(row,col+6))lostPoint+=40}}
      for(let col=0;col<moduleCount;col++){for(let row=0;row<moduleCount-6;row++){if(qr.isDark(row,col)&&!qr.isDark(row+1,col)&&qr.isDark(row+2,col)&&qr.isDark(row+3,col)&&qr.isDark(row+4,col)&&!qr.isDark(row+5,col)&&qr.isDark(row+6,col))lostPoint+=40}}
      let darkCount=0;for(let col=0;col<moduleCount;col++){for(let row=0;row<moduleCount;row++){if(qr.isDark(row,col))darkCount++}}
      const ratio=Math.abs(100*darkCount/moduleCount/moduleCount-50)/5;lostPoint+=10*ratio;return lostPoint}
  };
  const QRCode=function(typeNumber,ec){this.typeNumber=typeNumber;this.errorCorrectLevel=ec;this.modules=null;this.moduleCount=0;this.dataList=[];this.dataCache=null};
  QRCode.prototype.addData=function(data){this.dataList.push(new QR8bitByte(data));this.dataCache=null};
  QRCode.prototype.isDark=function(row,col){if(this.modules[row][col]==null)return false;return this.modules[row][col]};
  QRCode.prototype.getModuleCount=function(){return this.moduleCount};
  QRCode.prototype.make=function(){
    if(this.typeNumber<1){ // auto choose up to 10
      for(let t=1;t<=10;t++){this.typeNumber=t; if(this._makeImpl(false), this.dataCache) break;}
      return;
    }
    this._makeImpl(false);
  };
  QRCode.prototype._makeImpl=function(test){
    this.moduleCount=this.typeNumber*4+17; this.modules=new Array(this.moduleCount);
    for(let row=0;row<this.moduleCount;row++){this.modules[row]=new Array(this.moduleCount);for(let col=0;col<this.moduleCount;col++){this.modules[row][col]=null}}
    function ptn(qr,row,col){for(let r=-1;r<=7;r++){if(row+r<=-1||qr.moduleCount<=row+r)continue;for(let c=-1;c<=7;c++){if(col+c<=-1||qr.moduleCount<=col+c)continue;qr.modules[row+r][col+c]=(r>=0&&r<=6&&(c==0||c==6))||(c>=0&&c<=6&&(r==0||r==6))||(r>=2&&r<=4&&c>=2&&c<=4)} } }
    ptn(this,0,0); ptn(this,this.moduleCount-7,0); ptn(this,0,this.moduleCount-7);
    const pos=QRUtil.getPatternPosition(this.typeNumber); for(let i=0;i<pos.length;i++){for(let j=0;j<pos.length;j++){const row=pos[i],col=pos[j]; if(this.modules[row][col]!=null)continue; for(let r=-2;r<=2;r++){for(let c=-2;c<=2;c++){this.modules[row+r][col+c]= (r==-2||r==2||c==-2||c==2)||(r==0&&c==0)}}}}
    for(let i=8;i<this.moduleCount-8;i++){this.modules[i][6]= (i%2==0); this.modules[6][i]=(i%2==0)}
    let data = createData(this.typeNumber,this.errorCorrectLevel,this.dataList);
    let inc=-1,row=this.moduleCount-1,bitIndex=7,byteIndex=0,mask=0;
    for (let col=this.moduleCount-1; col>0; col-=2){
      if(col==6) col--;
      while(true){
        for(let c=0;c<2;c++){
          if(this.modules[row][col-c]==null){
            let dark=false;
            if(byteIndex<data.length){ dark=((data[byteIndex]>>>bitIndex)&1)==1 }
            const maskPattern=mask; this.modules[row][col-c]= maskPattern? ! (QRUtil.getMask(maskPattern,row,col-c) ? dark : !dark) : (QRUtil.getMask(maskPattern,row,col-c) ? !dark : dark);
            bitIndex--; if(bitIndex==-1){byteIndex++; bitIndex=7}
          }
        }
        row+=inc; if(row<0||this.moduleCount<=row){row-=inc; inc=-inc; break;}
      }
      if(!test){
        let minLost=0, best=0; for(let i=0;i<8;i++){this._makeImpl(true); let lost=QRUtil.getLostPoint(this); if(i==0||lost<minLost){minLost=lost;best=i} }
        mask=best; this._makeImpl(true);
      }
    }
    function createData(type,ecLevel,dataList){
      const rsBlocks=QRRSBlock.getRSBlocks(type,ecLevel);
      const buffer=new QRBitBuffer();
      for(let i=0;i<dataList.length;i++){const data=dataList[i]; buffer.put(4,4); buffer.put(data.getLength(), QRUtil.getLengthInBits(4,type)); data.write(buffer);}
      let totalDataCount=0; for(let i=0;i<rsBlocks.length;i++) totalDataCount+=rsBlocks[i].dataCount;
      if(buffer.length+4<=totalDataCount*8) buffer.put(0,4);
      while(buffer.length%8!=0) buffer.putBit(false);
      const dataLength=totalDataCount;
      const dataBytes=new Array(dataLength); for(let i=0;i<dataLength;i++) dataBytes[i]=0xff & (buffer.buffer[i]||0);
      return dataBytes;
    }
  };
  window._MiniQRCode = function(text){
    const qr=new QRCode(0,"L"); qr.addData(text); qr.make(); return qr;
  };
})();

/* ===================== QR helpers ===================== */
function sessionJSON(){
  if(!app.session) return "{}";
  const payload = {
    app:"EPS Observer",
    sessionId: app.sessionUID || (app.sessionUID=uid()),
    ts: app.session?.date || new Date().toISOString(),
    observers: app.session?.observers||[],
    champ: app.session?.champ,
    apsa: app.session?.apsa,
    niveau: app.session?.bac ? "BAC" : `N${app.session?.niveau}`,
    groups: (app.session?.groups||[]).map(g=>({
      names:g.names||[],
      comment:g.comment||"",
      items:(g.items||[]).map(it=>({label:String(it.text).split(" ‚Äî ")[0], pos:it.pos, neg:it.neg, level:it.level, note:it.note||""}))
    }))
  };
  return JSON.stringify(payload);
}
function drawQRFullScreen(){
  const canvas=$("qrCanvas"), ctx=canvas.getContext("2d");
  ctx.fillStyle="#fff"; ctx.fillRect(0,0,canvas.width,canvas.height);
  const json = sessionJSON();
  const qr = _MiniQRCode(json);
  const count = qr.getModuleCount();
  const size = Math.min(canvas.width, canvas.height);
  const margin = Math.floor(size*0.06);
  const cell = Math.floor((size - margin*2)/count);
  const offset = Math.floor((size - cell*count)/2);
  ctx.fillStyle="#000";
  for(let r=0;r<count;r++){
    for(let c=0;c<count;c++){
      if(qr.isDark(r,c)){
        ctx.fillRect(offset + c*cell, offset + r*cell, cell, cell);
      }
    }
  }
}

/* ===================== Navigation & actions ===================== */
function renderAll(){ renderChoose(); renderObservables(); renderGroupsTabs(); renderObserve(); renderBilan(); }

document.addEventListener("DOMContentLoaded", ()=>{
  load();
  document.documentElement.setAttribute("data-theme", app.settings.theme || "light");
  $("themeToggle").checked = (app.settings.theme==="dark");
  $("themeToggle").onchange = (e)=>{ app.settings.theme = e.target.checked ? "dark" : "light"; document.documentElement.setAttribute("data-theme", app.settings.theme); save(); };

  $("btnHelp").onclick = ()=> toggleModal("modalHelp", true);
  $("helpClose").onclick = ()=> toggleModal("modalHelp", false);
  $("btnHardReset").onclick = hardReset;

  $("goSetup").onclick = ()=> show("choose");

  $("obsInput").addEventListener("keydown",(e)=>{ if(["Enter",",",";"].includes(e.key)){ e.preventDefault(); const arr = $("obsInput").value.replace(/\r\n?/g,"\n").split(/[ ,;\n]+/).map(s=>s.trim()).filter(Boolean); app.observers = Array.from(new Set([...(app.observers||[]), ...arr])); $("obsInput").value=""; save(); renderChoose(); }});
  $("grpInput").addEventListener("keydown",(e)=>{ if(["Enter",",",";"].includes(e.key)){ e.preventDefault(); const arr = $("grpInput").value.replace(/\r\n?/g,"\n").split(/[ ,;\n]+/).map(s=>s.trim()).filter(Boolean); app.groupDefault = Array.from(new Set([...(app.groupDefault||[]), ...arr])); $("grpInput").value=""; save(); renderChoose(); }});

  $("optShowNotes").onchange = (e)=>{ app.settings.showNotes = e.target.checked; save(); renderObserve(); };
  $("optShowLevels").onchange = (e)=>{ app.settings.showLevels = e.target.checked; save(); renderObserve(); };
  $("optShowPM").onchange     = (e)=>{ app.settings.showPM = e.target.checked; save(); renderObserve(); };

  $("chronoMode").onchange = (e)=>{ app.timer.mode = e.target.value; resetChrono(); save(); };
  $("chronoStart").onclick = ()=> startChrono();
  $("chronoPause").onclick = ()=> pauseChrono();
  $("chronoReset").onclick = ()=> resetChrono();
  $("chronoLap").onclick   = ()=> addLap();
  updateChrono();

  $("backChoose").onclick = ()=> show("choose");
  $("btnAddObs").onclick = ()=>{ const v = $("newObs").value.trim(); if(!v) return; app.observables.push({text:v,pos:0,neg:0,level:"moyen",note:""}); $("newObs").value=""; save(); renderObservables(); };

  $("startObserve").onclick = ()=>{
    const items = app.observables.map(o=>({text:o.text, pos:0, neg:0, level:"moyen", note:""}));
    app.sessionUID = uid();
    app.session = { id: uid(), date: new Date().toISOString(), champ: app.selected.champ, apsa: app.selected.apsa, niveau: app.selected.niveau, bac: !!app.selected.bac, observers: [...(app.observers||[])], groups: [], activeGroupId: null };
    if((app.groupDefault||[]).length){ const g = { id: uid(), names:[...app.groupDefault], items: JSON.parse(JSON.stringify(items)), comment:"" }; app.session.groups.push(g); app.session.activeGroupId = g.id; }
    save(); renderGroupsTabs(); renderObserve(); show("observe");
  };

  $("addGroup").onclick = ()=>{
    if(!app.session){ alert("D√©marre d‚Äôabord une session."); return; }
    const names = prompt("Noms du groupe (s√©par√©s par virgule) :", ""); if(names==null) return;
    const arr = names.split(",").map(s=>s.trim()).filter(Boolean);
    const items = app.observables.map(o=>({text:o.text, pos:0, neg:0, level:"moyen", note:""}));
    const g = { id: uid(), names: arr, items, comment:"" };
    app.session.groups.push(g); app.session.activeGroupId = g.id; save(); renderGroupsTabs(); renderObserve();
  };

  $("obBack").onclick = ()=> show("observables");
  $("obAdd").onclick = ()=>{ const v = prompt("Nom de l'observable √† ajouter :"); if(!v) return; const it={text:v,pos:0,neg:0,level:"moyen",note:""}; const g = currentGroup(); if(!g){ alert("Ajoute d‚Äôabord un groupe."); return; } g.items.push(it); app.observables.push({text:v,pos:0,neg:0,level:"moyen",note:""}); save(); renderObserve(); };
  $("obEnd").onclick = ()=>{ if(!app.session){ alert("Pas de session en cours."); return; } toast("Session enregistr√©e (local)"); save(); };
  $("obToBilan").onclick = ()=>{ renderBilan(); show("bilan"); };

  $("bilanBack").onclick = ()=> show("observe");
  $("bilanExport").onclick = ()=> window.print();

  // QR plein √©cran
  $("btnShowQR").onclick = ()=>{
    renderBilan(); // s‚Äôassure que les derni√®res modifs sont dans le JSON
    drawQRFullScreen();
    toggleModal("qrFullscreen", true);
  };
  $("qrClose").onclick = ()=> toggleModal("qrFullscreen", false);

  function toggleModal(id,open){ const el=document.getElementById(id); if(el) el.classList.toggle("show", !!open); }
  window.toggleModal = toggleModal;

  window.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='hidden') save(); });
  window.addEventListener('beforeunload', save);

  renderAll(); show("cover");
});
</script>
</body>
</html>
